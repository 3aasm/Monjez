<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مُنجِز  | Monjez </title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=VT323&family=Changa:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Changa', 'sans-serif'],
                        pixel: ['VT323', 'monospace'],
                        display: ['Lalezar', 'cursive'],
                    },
                    colors: {
                        bit: {
                            bg: '#202028',
                            dark: '#0f0f15',
                            light: '#dedeff',
                            primary: '#5d5ced', 
                            accent: '#ffcd3c', 
                            danger: '#d94c4c', 
                            success: '#58d332', 
                            grey: '#8b9bb4',
                            glass: 'rgba(32, 32, 40, 0.9)'
                        }
                    },
                    boxShadow: {
                        'pixel': '4px 4px 0px 0px rgba(0,0,0,0.5)',
                        'pixel-sm': '2px 2px 0px 0px rgba(0,0,0,0.5)',
                        'pixel-lg': '6px 6px 0px 0px rgba(0,0,0,0.4)',
                        'pixel-inset': 'inset 4px 4px 0px 0px rgba(0,0,0,0.2)',
                    },
                    animation: {
                        'bounce-pixel': 'bouncePixel 1s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'blink': 'blink 1s step-end infinite',
                    },
                    keyframes: {
                        bouncePixel: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-4px)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        blink: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #202028;
            color: #dedeff;
            background-image: 
                linear-gradient(45deg, #1a1a20 25%, transparent 25%, transparent 75%, #1a1a20 75%, #1a1a20),
                linear-gradient(45deg, #1a1a20 25%, transparent 25%, transparent 75%, #1a1a20 75%, #1a1a20);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Pixel Utilities */
        .pixel-border {
            position: relative;
            background: #2e2e38;
            border: 4px solid #0f0f15;
            box-shadow: 4px 4px 0 #000;
        }
        
        .pixel-card {
            background-color: #2e2e38;
            border: 4px solid #0f0f15;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            position: relative;
        }

        .pixel-btn {
            background-color: #5d5ced;
            border: 4px solid #0f0f15;
            color: white;
            font-family: 'Changa', sans-serif;
            position: relative;
            box-shadow: 0 4px 0 #2a2a6b, 0 8px 0 rgba(0,0,0,0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .pixel-btn:active {
            box-shadow: 0 0 0 #2a2a6b, 0 0 0 rgba(0,0,0,0.4);
            transform: translateY(6px);
        }
        
        /* Variants */
        .pixel-btn.yellow { background-color: #ffcd3c; box-shadow: 0 4px 0 #b38f28, 0 8px 0 rgba(0,0,0,0.4); color: #000; }
        .pixel-btn.red { background-color: #d94c4c; box-shadow: 0 4px 0 #963434, 0 8px 0 rgba(0,0,0,0.4); }
        .pixel-btn.green { background-color: #58d332; box-shadow: 0 4px 0 #3a8c21, 0 8px 0 rgba(0,0,0,0.4); color: #000; }
        .pixel-btn.grey { background-color: #4b5563; box-shadow: 0 4px 0 #1f2937, 0 8px 0 rgba(0,0,0,0.4); }

        .pixel-input {
            background-color: #0f0f15;
            border: 4px solid #4b5563;
            color: white;
            padding: 8px;
            font-family: 'Changa', sans-serif;
        }
        .pixel-input:focus {
            border-color: #ffcd3c;
            outline: none;
        }

        /* View Management */
        .view-section { 
            display: none; 
            height: 100%;
            flex-direction: column;
        }
        .view-section.active { 
            display: flex; 
            animation: slideIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
            will-change: transform, opacity;
        }
        @keyframes slideIn { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* XP Bar */
        .pixel-progress {
            width: 100%;
            height: 16px;
            background: #0f0f15;
            border: 2px solid white;
            padding: 2px;
        }
        .pixel-progress-bar {
            height: 100%;
            background: #58d332;
            width: 0%;
            transition: width 0.5s steps(10);
        }

        /* Navigation */
        .nav-pixel.active {
            background-color: #ffcd3c;
            color: #0f0f15;
            transform: translateY(2px);
            border-bottom-width: 0;
            border-right-width: 0;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f15; }
        ::-webkit-scrollbar-thumb { background: #5d5ced; border: 2px solid #0f0f15; }
        
        /* Modal */
        .pixel-modal-bg {
            background-image: radial-gradient(#000 10%, transparent 10%);
            background-size: 5px 5px;
            background-color: rgba(0,0,0,0.7);
        }

        /* Boot Animation */
        .boot-finish { animation: bootFinish 0.8s cubic-bezier(0.7, 0, 0.3, 1) forwards; }
        @keyframes bootFinish { 
            0% { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }

        .scanlines {
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.3) 50%,
                rgba(0,0,0,0.3)
            );
            background-size: 100% 4px;
        }

        /* Rank Colors */
        .text-bronze { color: #cd7f32; text-shadow: 1px 1px 0 #000; }
        .text-silver { color: #c0c0c0; text-shadow: 1px 1px 0 #000; }
        .text-gold { color: #ffd700; text-shadow: 1px 1px 0 #000; }

        /* Logout Animation */
        .boot-down { animation: bootDown 1.5s cubic-bezier(0.7, 0, 0.3, 1) forwards; }
        @keyframes bootDown { 
            0% { transform: translateY(-100%); } 100% { transform: translateY(0); }
        }

        .rendering-pixelated {
            image-rendering: pixelated;
        }

        /* Full Screen Modal Animation */
        .modal-full-enter { animation: modalSlideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>

<body class="h-screen w-full flex flex-col items-center justify-center font-sans">

    <!-- Boot Screen -->
    <div id="boot-screen" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center overflow-hidden">
        <div class="absolute inset-0 scanlines opacity-10 pointer-events-none"></div>
        
        <!-- Logo Container -->
        <div class="relative z-10 flex flex-col items-center justify-center">
            <h1 id="boot-title" class="text-7xl font-display text-white tracking-widest opacity-0 transform -translate-y-10 transition-all duration-1000 ease-out drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">MONJEZ</h1>
            <div id="boot-line" class="w-0 h-1 bg-bit-accent my-4 shadow-[0_0_10px_#ffcd3c] transition-all duration-700 ease-in-out"></div>
            <p id="boot-sub" class="text-sm font-pixel text-bit-grey tracking-[0.5em] opacity-0 transform translate-y-10 transition-all duration-1000 ease-out">SYSTEM INITIALIZED</p>
        </div>

        <!-- Loading Indicator (Bottom) -->
        <div id="boot-loader" class="absolute bottom-10 flex gap-2 opacity-0 transition-opacity duration-500">
            <div class="w-2 h-2 bg-bit-success animate-bounce"></div>
            <div class="w-2 h-2 bg-bit-success animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-bit-success animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
    </div>

    <!-- Game Boy Frame -->
    <div id="main-frame" class="relative w-full h-full max-w-md mx-auto flex flex-col bg-bit-bg sm:border-x-4 sm:border-black shadow-2xl overflow-hidden transition-colors duration-500">
        
        <!-- HEADER: PLAYER INFO -->
        <header class="relative p-4 bg-bit-dark border-b-4 border-black flex justify-between items-center z-20 shrink-0">
            <!-- App Logo (Center) -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-gray-500/30 text-gray-500/30 px-3 py-1 rounded font-display tracking-widest pointer-events-none select-none text-xl">
                MONJEZ
            </div>

            <div class="flex items-center gap-3 cursor-pointer group" onclick="toggleAuthModal()">
                <div class="w-12 h-12 bg-white border-4 border-black relative overflow-hidden shrink-0 group-hover:scale-105 transition-transform">
                    <img id="avatar-img" src="https://via.placeholder.com/100" class="w-full h-full object-cover rendering-pixelated">
                </div>
                <div class="flex flex-col">
                    <h1 class="text-lg font-display text-bit-accent leading-none mb-1 truncate max-w-[120px] flex items-center gap-2"><span id="player-flag"></span> <span id="player-name">PLAYER 1</span></h1>
                    <div id="header-clock" class="text-[12px] font-pixel text-bit-grey tracking-widest flex items-center gap-1 opacity-80">
                        <i class="far fa-clock text-[10px]"></i> <span id="clock-time">--:--</span>
                    </div>
                </div>
            </div>
            
            <div class="text-right">
                <div class="text-2xl font-pixel text-white flex items-center justify-end gap-1">
                    <span id="xp-display">000</span> <i class="fas fa-star text-bit-accent text-sm"></i>
                </div>
                <div class="text-[10px] font-pixel text-bit-grey">LEVEL <span id="level-display">1</span></div>
                <button onclick="toggleHistory()" class="mt-1 flex items-center gap-1 bg-gray-800 border-2 border-gray-600 px-2 py-0.5 hover:border-white hover:text-white text-gray-400 text-[10px] font-pixel transition-all active:translate-y-0.5 rounded-sm">
                    <i class="fas fa-history"></i> <span data-i18n="history">HISTORY</span>
                </button>
            </div>
        </header>

        <!-- SCREEN (MAIN CONTENT) -->
        <main class="flex-grow overflow-hidden relative">
            
            <!-- ================= VIEW 1: QUESTS (TASKS) ================= -->
            <div id="view-quests" class="view-section active p-4 overflow-y-auto custom-scrollbar pb-24">
                
                <!-- Stats Banner -->
                <div onclick="openLeaderboard()" class="bg-bit-primary border-4 border-black p-3 text-center mb-4 shadow-pixel cursor-pointer hover:brightness-110 transition-all active:translate-y-1 group relative">
                    <div class="absolute top-1 right-1 text-[8px] bg-black/30 px-1 rounded text-white/70 group-hover:text-white"><i class="fas fa-trophy"></i> TOP 30</div>
                    <h2 class="text-xl font-display text-white mb-1" data-i18n="adventures">مغامرات اليوم</h2>
                    <div class="pixel-progress mb-1">
                        <div id="xp-bar" class="pixel-progress-bar"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-pixel text-white px-1">
                        <span id="pending-count">0 <span data-i18n="active">ACTIVE</span></span>
                        <span id="xp-text">0/100 XP</span>
                    </div>
                    <!-- Rank Status -->
                    <div class="mt-2 pt-2 border-t-2 border-black/20 flex justify-center items-center gap-2 text-[10px] font-pixel">
                        <span class="text-gray-400" data-i18n="rank_status">STATUS:</span>
                        <span id="rank-status-text" class="font-bold text-white">---</span>
                        <span class="text-gray-500">|</span>
                        <span class="text-gray-400">#</span><span id="rank-num" class="text-white">--</span>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="flex flex-col gap-2 mb-4">
                    <div class="flex gap-2">
                        <input type="text" id="quest-input" class="flex-grow pixel-input text-sm placeholder-gray-500" placeholder="مهمة جديدة..." data-i18n="new_quest_ph" onkeypress="if(event.key === 'Enter') addQuest()">
                        <input type="time" id="quest-time" class="w-20 pixel-input text-xs text-center">
                    </div>
                    
                    <div class="flex gap-2 h-10">
                        <div class="flex-grow bg-bit-dark border-4 border-black p-1 flex gap-1">
                            <button onclick="setPriority('low')" id="p-btn-low" class="flex-1 text-[10px] bg-blue-900 text-blue-300 hover:bg-blue-800 border border-transparent hover:border-white transition-all" data-i18n="normal">عادية</button>
                            <button onclick="setPriority('medium')" id="p-btn-medium" class="flex-1 text-[10px] bg-yellow-900 text-yellow-300 hover:bg-yellow-800 border border-transparent hover:border-white transition-all" data-i18n="medium">متوسطة</button>
                            <button onclick="setPriority('high')" id="p-btn-high" class="flex-1 text-[10px] bg-red-900 text-red-300 hover:bg-red-800 border border-transparent hover:border-white transition-all" data-i18n="boss">زعيم</button>
                        </div>
                        <button onclick="addQuest()" id="add-btn" class="w-16 bg-bit-success border-4 border-black text-black flex items-center justify-center hover:brightness-110 active:translate-y-1">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="edit-indicator" class="hidden text-xs text-bit-accent text-center bg-black p-1 border border-bit-accent">
                        <span data-i18n="editing">جاري التعديل...</span> <button onclick="cancelEdit()" class="underline text-red-400" data-i18n="discard">إلغاء</button>
                    </div>
                </div>

                <!-- Quest List -->
                <div id="quest-list" class="flex flex-col gap-3">
                    <!-- Tasks injected here -->
                </div>
                
                <div id="empty-state-quests" class="hidden flex-col items-center justify-center py-10 opacity-50">
                    <i class="fas fa-dungeon text-5xl mb-4 text-bit-grey"></i>
                    <p class="font-display text-lg text-bit-grey" data-i18n="no_active_quests">لا توجد مهام نشطة</p>
                </div>

            </div>

            <!-- ================= VIEW 2: BATTLE (TIMER) ================= -->
            <div id="view-battle" class="view-section p-4 overflow-y-auto custom-scrollbar pb-24">
                
                <!-- Battle Tabs -->
                <div class="flex gap-2 mb-4">
                    <button onclick="switchTimerMode('focus')" id="tab-focus" class="flex-1 pixel-btn text-sm py-2 bg-bit-primary border-b-0 active:translate-y-0" data-i18n="focus_battle">معركة تركيز</button>
                    <button onclick="switchTimerMode('stopwatch')" id="tab-stopwatch" class="flex-1 pixel-btn grey text-sm py-2 border-b-0 active:translate-y-0" data-i18n="stopwatch">ساعة إيقاف</button>
                </div>

                <div class="flex-grow flex flex-col items-center justify-center bg-bit-dark border-4 border-black p-6 relative shadow-pixel-lg text-center h-full max-h-[400px]">
                    
                    <!-- Stopwatch Reset Corner Button -->
                    <button onclick="resetTimer()" id="sw-reset-corner" class="hidden absolute top-2 right-2 text-[10px] pixel-btn red px-2 py-1 z-10" data-i18n="reset_again">اعد مره اخرا</button>

                    <!-- Boss/Timer Visual -->
                    <div class="mb-6 h-32 flex items-center justify-center relative w-full">
                         <!-- Focus Visual -->
                        <div id="visual-focus" class="absolute inset-0 flex items-center justify-center flex-col">
                             <i class="fas fa-dragon text-7xl text-bit-danger animate-bounce-pixel filter drop-shadow-[4px_4px_0_rgba(0,0,0,0.5)]"></i>
                             <div class="w-full max-w-[150px] mt-4 h-3 bg-black border border-white p-0.5">
                                 <div id="boss-hp" class="h-full bg-bit-danger w-full transition-all duration-1000"></div>
                             </div>
                             <span class="text-[8px] mt-1 font-pixel text-red-400">BOSS HP</span>
                        </div>
                        <!-- Stopwatch Visual -->
                        <div id="visual-stopwatch" class="absolute inset-0 flex items-center justify-center hidden">
                            <i class="fas fa-stopwatch text-7xl text-bit-accent animate-bounce-pixel filter drop-shadow-[4px_4px_0_rgba(0,0,0,0.5)]"></i>
                        </div>
                    </div>

                    <!-- Timer Digital -->
                    <div class="font-pixel text-7xl text-white mb-6 tracking-widest text-shadow-pixel" id="timer-display">25:00</div>
                    
                    <!-- Controls -->
                    <div class="flex justify-center gap-4 w-full">
                        <button onclick="toggleTimer()" id="timer-btn" class="pixel-btn yellow w-24 py-3 text-black font-bold text-xl" data-i18n="start">START</button>
                        <button onclick="recordLapOrReset()" id="timer-sec-btn" class="pixel-btn grey w-24 py-3 font-bold text-xl" data-i18n="reset">RESET</button>
                    </div>

                    <!-- Stopwatch Laps -->
                    <div id="laps-container" class="hidden w-full mt-4 h-24 overflow-y-auto border-2 border-dashed border-gray-600 p-2 text-left font-pixel text-sm text-gray-400">
                        <div class="text-center italic">-- NO LAPS --</div>
                    </div>

                    <!-- Focus Presets -->
                    <div id="focus-presets" class="flex gap-2 mt-6">
                        <button onclick="setTimer(25)" class="pixel-btn text-xs py-1 px-2">25m</button>
                        <button onclick="customTimer()" class="pixel-btn text-xs py-1 px-2" data-i18n="custom">تخصيص</button>
                        <button onclick="setTimer(15)" class="pixel-btn text-xs py-1 px-2">15m</button>
                        <button onclick="setTimer(5)" class="pixel-btn text-xs py-1 px-2">5m</button>
                    </div>
                </div>
            </div>

            <!-- ================= VIEW 3: INVENTORY (NOTES) ================= -->
            <div id="view-inventory" class="view-section p-4 overflow-y-auto custom-scrollbar pb-24">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-display text-xl text-bit-accent border-b-4 border-bit-accent pb-1" data-i18n="inventory">المخزون (ملاحظات)</h2>
                    <button onclick="openNoteModal()" class="pixel-btn green text-xs py-1 px-3 text-black font-bold" data-i18n="new_item">عنصر جديد +</button>
                </div>

                <div id="inventory-grid" class="grid grid-cols-1 gap-3">
                    <!-- Notes injected here -->
                </div>
                
                <div id="empty-state-notes" class="hidden flex-col items-center justify-center py-10 opacity-50">
                    <i class="fas fa-box-open text-5xl mb-4 text-bit-grey"></i>
                    <p class="font-display text-lg text-bit-grey" data-i18n="bag_empty">الحقيبة فارغة</p>
                </div>
            </div>

            <!-- ================= VIEW 4: GLOBAL CHAT ================= -->
            <div id="view-chat" class="view-section p-4 flex flex-col h-full pb-36 relative">
                <div class="bg-bit-primary border-4 border-black p-2 text-center mb-2 shadow-pixel flex justify-between items-center">
                    <h2 class="text-lg font-display text-white" data-i18n="global_chat">GLOBAL CHAT</h2>
                    <button onclick="openShareMenu()" class="pixel-btn yellow text-[10px] px-2 py-1 text-black font-bold" data-i18n="share_stats">SHARE STATS</button>
                </div>
                
                <div id="chat-messages" class="flex-grow overflow-y-auto custom-scrollbar flex flex-col gap-2 p-2 bg-black/20 border-4 border-black mb-2">
                    <div class="text-center text-gray-500 text-xs mt-4">CONNECTING...</div>
                </div>

                <div class="relative min-h-[3rem]">
                    <!-- Standard Controls -->
                    <div id="chat-controls" class="flex gap-2 w-full h-full">
                        <button id="chat-mic-btn" onclick="startRecording()" class="pixel-btn grey w-10 flex items-center justify-center shrink-0 text-white"><i class="fas fa-microphone"></i></button>
                        <button id="chat-cancel-btn" onclick="cancelEditMessage()" class="hidden pixel-btn red w-10 flex items-center justify-center shrink-0 text-white"><i class="fas fa-times"></i></button>
                        <input type="text" id="chat-input" class="flex-grow pixel-input text-sm" placeholder="..." data-i18n="say_something" onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button id="chat-send-btn" onclick="sendMessage()" class="pixel-btn green w-12 flex items-center justify-center text-black shrink-0"><i class="fas fa-paper-plane"></i></button>
                    </div>

                    <!-- Recording UI Overlay -->
                    <div id="recording-overlay" class="hidden absolute inset-0 bg-bit-dark border-4 border-bit-danger z-20 flex items-center justify-between px-3 shadow-pixel">
                        <div class="flex items-center gap-3 text-bit-danger font-pixel animate-pulse">
                            <i class="fas fa-circle text-xs"></i>
                            <span id="rec-timer" class="text-lg tracking-widest">00:00</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="cancelRecording()" class="pixel-btn grey w-10 h-8 flex items-center justify-center"><i class="fas fa-times"></i></button>
                            <button onclick="finishRecording()" class="pixel-btn green w-10 h-8 flex items-center justify-center text-black"><i class="fas fa-check"></i></button>
                        </div>
                    </div>

                    <!-- Delete Confirmation Overlay -->
                    <div id="delete-confirm-overlay" class="hidden absolute inset-0 bg-bit-dark border-4 border-bit-danger z-20 flex items-center justify-between px-3 shadow-pixel">
                        <div class="text-white font-pixel text-sm flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-bit-danger"></i>
                            <span data-i18n="delete_confirm">Delete message?</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="cancelDeleteMessage()" class="pixel-btn grey px-3 py-1 text-xs" data-i18n="discard">CANCEL</button>
                            <button onclick="confirmDeleteMessage()" class="pixel-btn red px-3 py-1 text-xs" data-i18n="delete">DELETE</button>
                        </div>
                    </div>

                    <!-- Message Options Overlay (Edit/Delete) -->
                    <div id="message-options-overlay" class="hidden absolute inset-0 bg-bit-dark border-4 border-bit-primary z-20 flex items-center justify-center gap-2 px-3 shadow-pixel">
                        <button onclick="triggerEditMessage()" class="pixel-btn blue flex-1 py-1 text-xs flex items-center justify-center gap-2 h-8"><i class="fas fa-pen"></i> <span data-i18n="edit">EDIT</span></button>
                        <button onclick="triggerDeleteMessage()" class="pixel-btn red flex-1 py-1 text-xs flex items-center justify-center gap-2 h-8"><i class="fas fa-trash"></i> <span data-i18n="delete">DELETE</span></button>
                        <button onclick="cancelMessageOptions()" class="pixel-btn grey w-10 h-8 flex items-center justify-center shrink-0"><i class="fas fa-times"></i></button>
                    </div>

                </div>

                <!-- Chat Restriction Overlay -->
                <div id="chat-restriction-overlay" class="absolute inset-0 z-40 bg-red-900/90 backdrop-blur-sm hidden flex-col items-center justify-center text-white">
                    <i class="fas fa-lock text-6xl mb-4 text-white animate-bounce"></i>
                    <h2 class="text-2xl font-display mb-2 tracking-widest">CHAT LOCKED</h2>
                    <div class="text-sm font-pixel text-red-200 mb-2">RESTRICTED ACCESS</div>
                    <div id="restriction-timer" class="font-pixel text-3xl tracking-widest bg-black/50 px-4 py-2 rounded border-2 border-red-500">00:00:00</div>
                </div>
            </div>

        </main>

        <!-- CONTROLLER (Navigation) -->
        <nav class="fixed bottom-0 w-full max-w-md bg-bit-dark border-t-4 border-black p-3 pb-6 flex justify-between items-end z-30 shadow-[0_-4px_0_rgba(0,0,0,0.2)]">
            <!-- D-Pad Decoration -->
            <div class="relative w-20 h-20 hidden sm:block opacity-40 pointer-events-none transform scale-75 origin-bottom-left">
                <div class="absolute top-0 left-8 w-8 h-8 bg-black"></div>
                <div class="absolute top-8 left-8 w-8 h-8 bg-gray-700"></div>
                <div class="absolute top-16 left-8 w-8 h-8 bg-black"></div>
                <div class="absolute top-8 left-0 w-8 h-8 bg-black"></div>
                <div class="absolute top-8 left-16 w-8 h-8 bg-black"></div>
            </div>

            <!-- Nav Buttons -->
            <div class="flex w-full gap-2 sm:w-auto sm:gap-4 px-1">
                <button onclick="switchView('quests')" class="nav-pixel active flex-1 sm:w-20 h-16 bg-bit-grey border-b-4 border-r-4 border-black rounded-sm flex flex-col items-center justify-center active:border-b-0 active:border-r-0 active:translate-y-1 active:translate-x-1 transition-all group" data-target="view-quests">
                    <i class="fas fa-scroll text-xl mb-1"></i>
                    <span class="text-[10px] font-pixel font-bold" data-i18n="quests">QUESTS</span>
                </button>
                
                <button onclick="switchView('battle')" class="nav-pixel flex-1 sm:w-20 h-16 bg-bit-grey border-b-4 border-r-4 border-black rounded-sm flex flex-col items-center justify-center active:border-b-0 active:border-r-0 active:translate-y-1 active:translate-x-1 transition-all group" data-target="view-battle">
                    <i class="fas fa-skull text-xl mb-1"></i>
                    <span class="text-[10px] font-pixel font-bold" data-i18n="battle">BATTLE</span>
                </button>
                
                <button onclick="switchView('inventory')" class="nav-pixel flex-1 sm:w-20 h-16 bg-bit-grey border-b-4 border-r-4 border-black rounded-sm flex flex-col items-center justify-center active:border-b-0 active:border-r-0 active:translate-y-1 active:translate-x-1 transition-all group" data-target="view-inventory">
                    <i class="fas fa-briefcase text-xl mb-1"></i>
                    <span class="text-[10px] font-pixel font-bold" data-i18n="items">ITEMS</span>
                </button>

                <button onclick="switchView('chat')" class="nav-pixel flex-1 sm:w-20 h-16 bg-bit-grey border-b-4 border-r-4 border-black rounded-sm flex flex-col items-center justify-center active:border-b-0 active:border-r-0 active:translate-y-1 active:translate-x-1 transition-all group" data-target="view-chat">
                    <i class="fas fa-comments text-xl mb-1"></i>
                    <span class="text-[10px] font-pixel font-bold" data-i18n="chat">CHAT</span>
                </button>
            </div>
            
            <!-- AB Buttons Decoration -->
             <div class="hidden sm:flex gap-2 opacity-40 transform scale-75 origin-bottom-right">
                <div class="w-10 h-10 rounded-full bg-red-800 border-b-4 border-black"></div>
                <div class="w-10 h-10 rounded-full bg-red-800 border-b-4 border-black mt-4"></div>
             </div>
        </nav>

        <!-- ================= MODALS ================= -->

        <!-- AUTH MODAL -->
        <div id="auth-modal" class="fixed inset-0 z-50 pixel-modal-bg hidden flex-col items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-bit-bg border-4 border-white p-6 w-full max-w-sm shadow-2xl relative">
                <button onclick="toggleAuthModal()" class="absolute top-2 left-3 text-red-500 hover:text-red-400 font-bold text-xl">X</button>
                
                <div id="auth-form-content">
                    <h2 class="text-2xl font-display text-bit-accent text-center mb-6 border-b-2 border-dashed border-gray-600 pb-2" data-i18n="data_save">DATA SAVE</h2>
                    
                    <div id="login-fields" class="flex flex-col gap-4">
                        <input type="text" id="auth-name" placeholder="PLAYER NAME" class="pixel-input hidden" data-i18n="name_ph">
                        <input type="email" id="auth-email" placeholder="EMAIL" class="pixel-input" data-i18n="email_ph">
                        <input type="password" id="auth-pass" placeholder="PASSWORD" class="pixel-input" data-i18n="pass_ph">
                        
                        <!-- Country Selector -->
                        <div id="auth-country-select" class="hidden flex-col gap-1">
                            <label class="text-xs text-gray-400" data-i18n="select_country">SELECT COUNTRY:</label>
                            <div class="flex flex-wrap gap-2 justify-center" id="country-options">
                                <!-- Populated by JS -->
                            </div>
                            <input type="hidden" id="selected-country" value="global">
                        </div>

                        <div id="auth-photo-select" class="hidden">
                            <label class="text-xs text-gray-400 mb-1 block" data-i18n="select_avatar">SELECT AVATAR:</label>
                            <input type="file" id="auth-file" accept="image/*" class="text-xs text-gray-400" onchange="handleFileSelect(this)">
                            <img id="auth-preview" src="" class="w-16 h-16 mt-2 border-2 border-white object-cover hidden rendering-pixelated">
                        </div>

                        <button onclick="handleAuth()" id="auth-action-btn" class="pixel-btn green py-2 mt-2" data-i18n="load_game">LOAD GAME (LOGIN)</button>
                        <p onclick="toggleAuthMode()" id="auth-switch-text" class="text-center text-xs text-gray-400 cursor-pointer hover:text-white mt-2" data-i18n="new_game_q">NEW GAME? (SIGN UP)</p>
                    </div>

                    <!-- Profile View (When Logged In) -->
                    <div id="profile-view" class="hidden flex-col items-center gap-4">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('update-photo').click()">
                            <img id="profile-img-lg" src="https://via.placeholder.com/100" class="w-24 h-24 border-4 border-white object-cover bg-black rendering-pixelated">
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <input type="file" id="update-photo" class="hidden" accept="image/*" onchange="updateProfilePhoto(this)">
                        
                        <div class="text-center relative">
                            <h3 class="text-xl font-bold text-bit-accent flex items-center justify-center gap-2">
                                <span id="profile-name-lg">PLAYER</span>
                                <button onclick="editProfileName()" class="text-xs text-gray-400 hover:text-white"><i class="fas fa-pen"></i></button>
                            </h3>
                            <p class="text-xs text-gray-500 font-pixel" id="profile-email-lg">EMAIL</p>
                        </div>

                        <!-- Account Actions -->
                        <div class="w-full flex flex-col gap-2 mt-2">
                            <button onclick="showChangePassword()" class="pixel-btn yellow w-full py-2 text-xs" data-i18n="change_pass">CHANGE PASSWORD</button>
                            <button onclick="showDeleteAccount()" class="pixel-btn red w-full py-2 text-xs" data-i18n="delete_acc">DELETE ACCOUNT</button>
                        </div>

                        <!-- Action Forms (Hidden) -->
                        <div id="action-form-pass" class="hidden w-full flex-col gap-2 bg-black p-2 border-2 border-gray-600">
                            <p class="text-xs text-center text-yellow-400 mb-1" data-i18n="change_pass">CHANGE PASSWORD</p>
                            <input type="password" id="cp-current" placeholder="CURRENT PASS" class="pixel-input text-xs w-full" data-i18n="curr_pass">
                            <input type="password" id="cp-new" placeholder="NEW PASS" class="pixel-input text-xs w-full" data-i18n="new_pass">
                            <input type="password" id="cp-confirm" placeholder="CONFIRM PASS" class="pixel-input text-xs w-full" data-i18n="conf_pass">
                            <div class="flex gap-2">
                                <button onclick="confirmChangePassword()" class="pixel-btn green flex-1 py-1 text-xs">OK</button>
                                <button onclick="hideActionForms()" class="pixel-btn grey flex-1 py-1 text-xs">X</button>
                            </div>
                        </div>

                        <div id="action-form-del" class="hidden w-full flex-col gap-2 bg-black p-2 border-2 border-red-600">
                            <p class="text-xs text-center text-red-500 mb-1 font-bold" data-i18n="delete_acc_confirm">DELETE ACCOUNT?</p>
                            <input type="password" id="del-pass" placeholder="PASSWORD" class="pixel-input text-xs w-full" data-i18n="pass_ph">
                            <div class="flex gap-2">
                                <button onclick="confirmDeleteAccount()" class="pixel-btn red flex-1 py-1 text-xs">DELETE</button>
                                <button onclick="hideActionForms()" class="pixel-btn grey flex-1 py-1 text-xs">CANCEL</button>
                            </div>
                        </div>
                        
                        <!-- Profile Country Selector -->
                        <div class="w-full flex flex-col items-center gap-1">
                            <label class="text-[10px] text-gray-500 font-pixel" data-i18n="select_country">SELECT COUNTRY</label>
                            <div class="flex flex-wrap gap-2 justify-center" id="profile-country-options"></div>
                        </div>

                        <!-- Language Switcher -->
                        <div class="flex gap-2 w-full">
                            <button onclick="setLanguage('ar')" class="flex-1 pixel-btn grey text-xs py-2">العربية</button>
                            <button onclick="setLanguage('en')" class="flex-1 pixel-btn grey text-xs py-2">ENGLISH</button>
                        </div>

                        <!-- Sound Toggle -->
                        <button onclick="toggleSound()" id="sound-toggle-btn" class="pixel-btn green w-full py-2 text-xs">SOUND: ON</button>

                        <button onclick="handleLogout()" class="pixel-btn red w-full py-2" data-i18n="logout">QUIT GAME (LOGOUT)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTE MODAL (Add/Edit) -->
        <div id="note-modal" class="fixed inset-0 z-[60] bg-bit-bg hidden flex-col modal-full-enter">
            <!-- Header -->
            <div class="bg-bit-dark border-b-4 border-black p-4 flex items-center justify-between shrink-0 shadow-pixel z-10">
                <button onclick="closeNoteModal()" class="text-white hover:text-bit-accent text-xl active:scale-90 transition-transform">
                    <i class="fas fa-arrow-left rtl:rotate-180"></i>
                </button>
                <div class="font-display text-xl text-bit-accent tracking-wider" data-i18n="item_details">ITEM DETAILS</div>
                <button onclick="saveNote()" class="text-bit-success hover:text-white text-xl active:scale-90 transition-transform">
                    <i class="fas fa-save"></i>
                </button>
            </div>
                
            <!-- Content -->
            <div class="flex-grow p-6 flex flex-col gap-6 overflow-y-auto custom-scrollbar">
                <input type="hidden" id="note-id">
                
                <div class="flex flex-col gap-2">
                    <label class="text-[10px] font-pixel text-bit-grey uppercase tracking-widest">Title</label>
                    <input type="text" id="note-title" placeholder="ITEM NAME" class="w-full bg-transparent border-b-4 border-gray-700 text-2xl font-display text-white focus:border-bit-accent focus:outline-none px-2 py-1 transition-colors" data-i18n="item_name_ph">
                </div>

                <div class="flex flex-col gap-2 flex-grow">
                    <label class="text-[10px] font-pixel text-bit-grey uppercase tracking-widest">Description</label>
                    <textarea id="note-body" placeholder="DESCRIPTION..." class="w-full flex-grow bg-bit-dark border-4 border-black text-white p-4 font-sans text-lg leading-relaxed focus:border-bit-accent focus:outline-none resize-none shadow-inner" data-i18n="desc_ph"></textarea>
                </div>

                <button onclick="closeNoteModal()" class="pixel-btn red py-3 w-full shrink-0" data-i18n="discard">DISCARD CHANGES</button>
            </div>
        </div>

        <!-- LEADERBOARD MODAL -->
        <div id="leaderboard-modal" class="fixed inset-0 z-50 pixel-modal-bg hidden items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-bit-bg border-4 border-white p-4 w-full max-w-sm shadow-2xl relative flex flex-col h-[70vh]">
                <div class="flex justify-between items-center mb-4 border-b-2 border-dashed border-gray-600 pb-2">
                    <h3 class="text-xl font-display text-bit-accent"><i class="fas fa-trophy text-yellow-400 mr-1"></i> <span data-i18n="leaderboard">TOP PLAYERS</span></h3>
                    <button onclick="closeLeaderboard()" class="text-red-500 font-bold">X</button>
                </div>
                
                <div class="flex justify-between text-[10px] text-gray-500 px-2 mb-1 font-pixel">
                    <span data-i18n="rank">RANK</span>
                    <span data-i18n="score">LEVEL / XP</span>
                </div>
                <div id="leaderboard-list" class="flex-grow overflow-y-auto custom-scrollbar flex flex-col gap-2 p-1">
                    <!-- Leaderboard items -->
                    <div class="text-center text-gray-500 mt-10 animate-pulse">LOADING...</div>
                </div>
            </div>
        </div>

        <!-- SHARE STATS MODAL -->
        <div id="share-modal" class="fixed inset-0 z-[80] pixel-modal-bg hidden items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-bit-bg border-4 border-white p-4 w-full max-w-sm shadow-2xl relative flex flex-col gap-3">
                <div class="flex justify-between items-center border-b-2 border-dashed border-gray-600 pb-2">
                    <h3 class="text-lg font-display text-bit-accent" data-i18n="share_stats">SHARE STATS</h3>
                    <button onclick="closeShareModal()" class="text-red-500 font-bold">X</button>
                </div>
                
                <button onclick="confirmShare('rank')" class="pixel-btn grey py-3 text-sm flex items-center justify-center gap-2">
                    <i class="fas fa-trophy text-yellow-400"></i> <span data-i18n="share_rank">SHARE RANK (#<span id="share-rank-val">--</span>)</span>
                </button>
                
                <button onclick="confirmShare('xp')" class="pixel-btn grey py-3 text-sm flex items-center justify-center gap-2">
                    <i class="fas fa-star text-bit-success"></i> <span data-i18n="share_xp">SHARE XP (<span id="share-xp-val">--</span>)</span>
                </button>

                <!-- VIP Section -->
                <div id="vip-share-section" class="relative flex flex-col gap-2 border-t-2 border-gray-700 pt-2 mt-1">
                    <div class="text-[10px] text-center text-gold font-pixel uppercase tracking-widest mb-1">
                        <i class="fas fa-trophy"></i> TOP 10 EXCLUSIVE
                    </div>
                    <input type="text" id="vip-msg-input" class="pixel-input text-xs w-full text-center" placeholder="VIP MESSAGE..." maxlength="30">
                    <button onclick="confirmShare('vip')" id="vip-send-btn" class="pixel-btn yellow py-2 text-xs font-bold text-black" data-i18n="send">SEND</button>
                    
                    <!-- Lock Overlay -->
                    <div id="vip-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-[1px] flex flex-col items-center justify-center z-10 hidden">
                        <i class="fas fa-lock text-2xl text-gray-400 mb-1"></i>
                        <span class="text-[8px] text-gray-300 font-pixel bg-black/50 px-2 py-1 rounded" data-i18n="vip_locked">LOCKED</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY MODAL -->
        <div id="history-modal" class="fixed inset-0 z-50 pixel-modal-bg hidden items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-bit-bg border-4 border-white p-4 w-full max-w-sm shadow-2xl relative flex flex-col h-[70vh]">
                <div class="flex justify-between items-center mb-4 border-b-2 border-dashed border-gray-600 pb-2">
                    <h3 class="text-xl font-display text-bit-accent" data-i18n="quest_log">QUEST LOG</h3>
                    <button onclick="toggleHistory()" class="text-red-500 font-bold">X</button>
                </div>
                
                <div id="history-list" class="flex-grow overflow-y-auto custom-scrollbar flex flex-col gap-2 p-1">
                    <!-- History items -->
                </div>
                
                <button onclick="clearHistory()" class="mt-4 pixel-btn grey text-xs py-2" data-i18n="clear_logs">CLEAR LOGS</button>
            </div>
        </div>

        <!-- VIEW PLAYER PROFILE MODAL -->
        <div id="player-modal" class="fixed inset-0 z-[70] pixel-modal-bg hidden items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-bit-bg border-4 border-white p-6 w-full max-w-sm shadow-2xl relative flex flex-col items-center gap-4">
                <button onclick="closePlayerProfile()" class="absolute top-2 left-3 text-red-500 hover:text-red-400 font-bold text-xl">X</button>
                
                <div class="w-24 h-24 border-4 border-white relative shadow-pixel">
                    <img id="view-player-img" src="" class="w-full h-full object-cover bg-black rendering-pixelated">
                </div>
                
                <div class="text-center w-full">
                    <h2 id="view-player-name" class="text-2xl font-display text-bit-accent mb-2 truncate">PLAYER</h2>
                    <div class="bg-bit-dark border-2 border-gray-600 p-2 w-full">
                        <div class="text-white font-pixel text-xl"><span id="view-player-xp" class="text-bit-success">0</span> XP</div>
                    </div>
                </div>

                <!-- Report Button -->
                <button onclick="toggleReportForm()" class="pixel-btn red w-full py-2 text-xs mt-2" data-i18n="report_player">REPORT PLAYER</button>
                
                <!-- Report Options -->
                <div id="report-form" class="hidden w-full flex-col gap-2 bg-black p-2 border-2 border-red-600 mt-1">
                    <p class="text-[10px] text-center text-red-500 mb-1 font-bold" data-i18n="select_reason">SELECT REASON</p>
                    <button onclick="submitReport('Spam/Ads')" class="pixel-btn grey w-full py-1 text-[10px]" data-i18n="spam">SPAM</button>
                    <button onclick="submitReport('Harassment')" class="pixel-btn grey w-full py-1 text-[10px]" data-i18n="harassment">HARASSMENT</button>
                    <div class="flex gap-1">
                        <input type="text" id="report-custom-input" class="pixel-input text-[10px] flex-grow w-full" data-i18n="other_reason" placeholder="...">
                        <button onclick="submitReport('custom')" class="pixel-btn red px-2 text-[10px]"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WARNING MODAL (ADMIN SYSTEM) -->
        <div id="warning-modal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 hidden backdrop-blur-sm">
            <div class="bg-red-900 border-4 border-red-500 p-6 max-w-sm text-center shadow-[0_0_20px_rgba(220,38,38,0.5)] m-4 relative">
                <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4 animate-bounce"></i>
                <h2 class="text-2xl font-display text-white mb-2 tracking-wider">تحذير من أمن منجز</h2>
                <p id="warning-text" class="text-white font-sans mb-6 text-lg leading-relaxed border-y border-red-700 py-4">...</p>
                <button onclick="dismissWarning()" class="pixel-btn white px-8 py-2 font-bold text-black bg-white hover:bg-gray-200">فهمت</button>
            </div>
        </div>

        <!-- BAN NOTIFICATION MODAL -->
        <div id="ban-modal" class="fixed inset-0 z-[210] flex items-center justify-center bg-black/90 hidden backdrop-blur-md">
            <div class="bg-bit-dark border-4 border-red-600 p-6 max-w-sm text-center shadow-[0_0_30px_rgba(220,38,38,0.6)] m-4 relative">
                <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-1 font-display tracking-widest border-2 border-black">BANNED</div>
                <i class="fas fa-ban text-6xl text-red-500 mb-6 mt-4"></i>
                <h2 class="text-xl font-display text-white mb-4">تم حظر الدردشة مؤقتاً</h2>
                <p id="ban-reason-text" class="text-gray-400 text-sm mb-6 font-pixel">You have been restricted from using the global chat.</p>
                <div id="ban-modal-timer" class="text-2xl font-pixel text-white mb-6">--:--</div>
                <button onclick="closeBanModal()" class="pixel-btn red px-8 py-2 font-bold text-white w-full">I UNDERSTAND</button>
            </div>
        </div>

    </div>

    <!-- SOUNDS -->
    <audio id="sfx-coin" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-jump" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="sfx-hit" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <script>
        // --- CONFIG ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB3IDkykHcq7eOZ_psgqP1-Edgqgb7_2wY", 
            authDomain: "monjez-5fef8.firebaseapp.com", 
            projectId: "monjez-5fef8", 
            storageBucket: "monjez-5fef8.firebasestorage.app", 
            messagingSenderId: "389640182212", 
            appId: "1:389640182212:web:3b67460cd41949c97aac91" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- TRANSLATIONS ---
        const translations = {
            ar: {
                history: "السجل",
                adventures: "مغامرات اليوم",
                active: "نشط",
                new_quest_ph: "مهمة جديدة...",
                normal: "عادية",
                medium: "متوسطة",
                boss: "زعيم",
                no_active_quests: "لا توجد مهام نشطة",
                focus_battle: "معركة تركيز",
                stopwatch: "ساعة إيقاف",
                start: "ابدأ",
                reset: "إعادة",
                inventory: "المخزون",
                new_item: "عنصر جديد +",
                bag_empty: "الحقيبة فارغة",
                quests: "المهام",
                battle: "التوقيت",
                items: "المفكرة",
                player_card: "بطاقة اللاعب",
                logout: "خروج (تسجيل خروج)",
                save: "حفظ",
                discard: "إلغاء",
                item_details: "تفاصيل العنصر",
                quest_log: "سجل المهام",
                clear_logs: "مسح السجل",
                load_game: "تحميل اللعبة (دخول)",
                new_game_q: "لعبة جديدة؟ (تسجيل)",
                create_game: "إنشاء (تسجيل)",
                has_save_q: "لديك حفظ؟ (دخول)",
                data_save: "حفظ البيانات",
                select_avatar: "اختر شخصية:",
                item_name_ph: "اسم العنصر",
                desc_ph: "الوصف...",
                email_ph: "البريد الإلكتروني",
                pass_ph: "كلمة المرور",
                name_ph: "اسم اللاعب",
                editing: "جاري التعديل...",
                custom: "تخصيص",
                reset_again: "اعد مره اخرا",
                select_country: "اختر الدولة:",
                leaderboard: "أفضل المستخدمين",
                rank: "الترتيب",
                score: "المستوى / XP",
                no_players: "لا يوجد رسائل",
                chat: "الدردشة",
                global_chat: "الدردشة العالمية",
                say_something: "قل شيئاً...",
                send: "إرسال",
                share_stats: "شارك إنجازي",
                login_to_chat: "سجل دخولك للدردشة",
                sound_on: "الصوت: مفعل",
                sound_off: "الصوت: معطل",
                chat_deleted: "تم حذف الدردشة",
                delete_confirm: "هل أنت متأكد من الحذف؟",
                edit: "تعديل",
                change_pass: "تغيير كلمة المرور",
                delete_acc: "حذف الحساب",
                curr_pass: "كلمة المرور الحالية",
                new_pass: "كلمة المرور الجديدة",
                conf_pass: "تأكيد كلمة المرور",
                delete_acc_confirm: "حذف الحساب نهائياً؟",
                edit_name_cost: "تعديل الاسم يكلف 300 XP. موافق؟",
                no_xp: "لا يوجد XP كافي!",
                rank_status: "الحالة:",
                logging_out: "جاري تسجيل الخروج...",
                share_rank: "مشاركة الترتيب",
                share_xp: "مشاركة النقاط",
                vip_locked: "متاح للأوائل (Top 10) فقط",
                report_player: "إبلاغ عن اللاعب",
                select_reason: "اختر سبب الإبلاغ",
                spam: "سبام / إعلانات",
                harassment: "مضايقة / شتائم",
                other_reason: "سبب آخر...",
                report_sent: "تم إرسال البلاغ بنجاح"
            },
            en: {
                history: "HISTORY",
                adventures: "TODAY'S QUESTS",
                active: "ACTIVE",
                new_quest_ph: "New Quest...",
                normal: "NORMAL",
                medium: "MEDIUM",
                boss: "BOSS",
                no_active_quests: "NO ACTIVE QUESTS",
                focus_battle: "FOCUS BATTLE",
                stopwatch: "STOPWATCH",
                start: "START",
                reset: "RESET",
                inventory: "INVENTORY",
                new_item: "NEW ITEM +",
                bag_empty: "BAG IS EMPTY",
                quests: "QUESTS",
                battle: "BATTLE",
                items: "ITEMS",
                player_card: "PLAYER CARD",
                logout: "QUIT GAME (LOGOUT)",
                save: "SAVE",
                discard: "DISCARD",
                item_details: "ITEM DETAILS",
                quest_log: "QUEST LOG",
                clear_logs: "CLEAR LOGS",
                load_game: "LOAD GAME (LOGIN)",
                new_game_q: "NEW GAME? (SIGN UP)",
                create_game: "CREATE (SIGN UP)",
                has_save_q: "HAS SAVE? (LOGIN)",
                data_save: "DATA SAVE",
                select_avatar: "SELECT AVATAR:",
                item_name_ph: "ITEM NAME",
                desc_ph: "DESCRIPTION...",
                email_ph: "EMAIL",
                pass_ph: "PASSWORD",
                name_ph: "PLAYER NAME",
                editing: "EDITING...",
                custom: "CUSTOM",
                reset_again: "RESET AGAIN",
                select_country: "SELECT COUNTRY:",
                leaderboard: "TOP PLAYERS",
                rank: "RANK",
                score: "LEVEL / XP",
                no_players: "NO PLAYERS YET",
                chat: "CHAT",
                global_chat: "GLOBAL CHAT",
                say_something: "Say something...",
                send: "SEND",
                share_stats: "SHARE STATS",
                login_to_chat: "LOGIN TO CHAT",
                sound_on: "SOUND: ON",
                sound_off: "SOUND: OFF",
                chat_deleted: "Chat deleted",
                delete_confirm: "Delete message?",
                edit: "EDIT",
                change_pass: "CHANGE PASSWORD",
                delete_acc: "DELETE ACCOUNT",
                curr_pass: "CURRENT PASS",
                new_pass: "NEW PASS",
                conf_pass: "CONFIRM PASS",
                delete_acc_confirm: "DELETE ACCOUNT PERMANENTLY?",
                edit_name_cost: "Rename costs 300 XP. Proceed?",
                no_xp: "Not enough XP!",
                rank_status: "STATUS:",
                logging_out: "LOGGING OUT...",
                share_rank: "SHARE RANK",
                share_xp: "SHARE XP",
                vip_locked: "REACH TOP 10 TO UNLOCK",
                report_player: "REPORT PLAYER",
                select_reason: "SELECT REASON",
                spam: "SPAM / ADS",
                harassment: "HARASSMENT",
                other_reason: "Other reason...",
                report_sent: "REPORT SENT SUCCESSFULLY"
            }
        };

        let currentLang = localStorage.getItem('pixel_lang') || 'ar';

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('pixel_lang', lang);
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) {
                    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translations[lang][key];
                    } else {
                        // Preserve icons if they exist as first child
                        if(el.children.length > 0 && el.firstElementChild.tagName === 'I') {
                             const icon = el.firstElementChild.cloneNode(true);
                             el.innerHTML = '';
                             el.appendChild(icon);
                             el.appendChild(document.createTextNode((lang === 'ar' ? ' ' : '') + translations[lang][key]));
                        } else {
                            el.textContent = translations[lang][key];
                        }
                    }
                }
            });
            
            // Update dynamic elements
            updateAuthUI();
            updateSoundButton();
            updateTimerButtons();
        }

        function updateAuthUI() {
            const title = document.querySelector('#auth-form-content h2');
            const btn = document.getElementById('auth-action-btn');
            const switchText = document.getElementById('auth-switch-text');
            
            if(isLoginMode) {
                title.textContent = translations[currentLang].load_game;
                btn.textContent = translations[currentLang].load_game;
                switchText.textContent = translations[currentLang].new_game_q;
            } else {
                title.textContent = translations[currentLang].create_game;
                btn.textContent = translations[currentLang].create_game;
                switchText.textContent = translations[currentLang].has_save_q;
            }
        }

        function updateTimerButtons() {
            const btn = document.getElementById('timer-btn');
            const secBtn = document.getElementById('timer-sec-btn');
            
            if(!state.timer.isRunning) {
                btn.textContent = translations[currentLang].start;
            }
            
            if(state.timer.mode === 'focus') {
                secBtn.textContent = translations[currentLang].reset;
            }
        }

        // --- STATE ---
        let state = {
            user: null,
            quests: JSON.parse(localStorage.getItem('pixel_quests')) || [],
            inventory: JSON.parse(localStorage.getItem('pixel_inventory')) || [],
            history: JSON.parse(localStorage.getItem('pixel_history')) || [],
            xp: parseInt(localStorage.getItem('pixel_xp')) || 0,
            timer: { 
                mode: 'focus', // focus or stopwatch
                interval: null, 
                timeLeft: 25 * 60, 
                initial: 25 * 60, 
                isRunning: false,
                swStartTime: 0,
                swElapsed: 0
            },
            editingQuestId: null,
            editingMessageId: null,
            selectedMessageId: null,
            reportTargetUid: null,
            rank: null,
            isMuted: false,
            banInterval: null,
            mutedUntil: null
        };

        const priorityColors = {
            low: { border: 'border-blue-500', icon: 'text-blue-400' },
            medium: { border: 'border-yellow-500', icon: 'text-yellow-400' },
            high: { border: 'border-red-500', icon: 'text-red-500' }
        };

        // --- RANK SYSTEM ---
        function getRankColorClass(xp) {
            if (xp >= 5000) return 'text-gold';
            if (xp >= 2000) return 'text-silver';
            return 'text-bronze';
        }

        function getRankTitle(xp) {
            if (xp >= 5000) return currentLang === 'ar' ? 'عالي (ذهبي)' : 'HIGH (GOLD)';
            if (xp >= 2000) return currentLang === 'ar' ? 'متوسط (فضي)' : 'MEDIUM (SILVER)';
            if (xp >= 500) return currentLang === 'ar' ? 'ضعيف (برونزي)' : 'WEAK (BRONZE)';
            return currentLang === 'ar' ? 'تحت الضعيف' : 'BEGINNER';
        }

        // --- COUNTRIES ---
        const countries = [
            { code: 'sa', flag: '🇸🇦' },
            { code: 'ae', flag: '🇦🇪' },
            { code: 'kw', flag: '🇰🇼' },
            { code: 'qa', flag: '🇶🇦' },
            { code: 'bh', flag: '🇧🇭' },
            { code: 'om', flag: '🇴🇲' },
            { code: 'global', flag: '🌍' }
        ];

        // --- AUDIO ---
        let soundEnabled = localStorage.getItem('pixel_sound') !== 'off';

        function playSfx(id) {
            if(!soundEnabled) return;
            const audio = document.getElementById(`sfx-${id}`);
            if(audio) { audio.currentTime = 0; audio.volume = 0.3; audio.play().catch(()=>{}); }
        }

        // --- AUTH SYSTEM ---
        let isLoginMode = true;
        let selectedAvatarBase64 = null;

        auth.onAuthStateChanged(user => {
            state.user = user;
            updateUIForUser();
            if(user) loadCloudData();
            if(user) initAdminListeners(user.uid);
        });

        function updateUIForUser() {
            const u = state.user;
            const avatar = document.getElementById('avatar-img');
            const name = document.getElementById('player-name');
            const loginFields = document.getElementById('login-fields');
            const profileView = document.getElementById('profile-view');
            const title = document.querySelector('#auth-form-content h2');
            const flagDisplay = document.getElementById('player-flag');

            if(u) {
                avatar.src = u.photoURL || 'https://via.placeholder.com/100';
                name.textContent = (u.displayName || 'PLAYER').toUpperCase();
                name.className = `text-lg font-display leading-none mb-1 truncate max-w-[120px] flex items-center gap-2 ${getRankColorClass(state.xp)}`;
                
                // Modal Content
                loginFields.classList.add('hidden');
                profileView.classList.remove('hidden');
                profileView.classList.add('flex');
                title.textContent = translations[currentLang].player_card;
                
                document.getElementById('profile-name-lg').textContent = u.displayName;
                document.getElementById('profile-name-lg').className = `text-xl font-bold ${getRankColorClass(state.xp)}`;
                document.getElementById('profile-img-lg').src = u.photoURL || 'https://via.placeholder.com/100';
                document.getElementById('profile-email-lg').textContent = u.email;

                // Check custom photo in Firestore
                db.collection('users').doc(u.uid).get().then(doc => {
                    if(doc.exists && doc.data().photoBase64) {
                        avatar.src = doc.data().photoBase64;
                        document.getElementById('profile-img-lg').src = doc.data().photoBase64;
                    }
                    // Set Flag
                    let currentCountry = 'global';
                    if(doc.exists && doc.data().country) {
                        currentCountry = doc.data().country;
                        const c = countries.find(x => x.code === currentCountry);
                        flagDisplay.textContent = c ? c.flag : '🌍';
                    }
                    // Sync Name if missing in Firestore
                    if(doc.exists && !doc.data().name && u.displayName) {
                        db.collection('users').doc(u.uid).set({ name: u.displayName }, { merge: true });
                    }
                    renderProfileCountryOptions(currentCountry);
                    updatePlayerRank();
                });
                updateSoundButton();
            } else {
                avatar.src = 'https://via.placeholder.com/100';
                name.textContent = "PLAYER 1";
                flagDisplay.textContent = "";
                loginFields.classList.remove('hidden');
                profileView.classList.add('hidden');
                profileView.classList.remove('flex');
                updateAuthUI();
            }
        }

        function toggleAuthModal() {
            const modal = document.getElementById('auth-modal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
            playSfx('jump');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const nameInput = document.getElementById('auth-name');
            const photoInput = document.getElementById('auth-photo-select');
            const countryInput = document.getElementById('auth-country-select');

            if(isLoginMode) {
                nameInput.classList.add('hidden');
                photoInput.classList.add('hidden');
                countryInput.classList.add('hidden');
            } else {
                nameInput.classList.remove('hidden');
                photoInput.classList.remove('hidden');
                countryInput.classList.remove('hidden');
                renderCountryOptions();
            }
            updateAuthUI();
        }

        function renderCountryOptions() {
            const container = document.getElementById('country-options');
            container.innerHTML = '';
            countries.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "w-8 h-8 bg-bit-dark border-2 border-gray-600 hover:border-white flex items-center justify-center text-lg transition-all";
                btn.textContent = c.flag;
                btn.onclick = () => selectCountry(c.code, btn);
                container.appendChild(btn);
            });
            // Select global by default
            selectCountry('global', container.lastChild);
        }

        function selectCountry(code, btn) {
            document.getElementById('selected-country').value = code;
            document.querySelectorAll('#country-options button').forEach(b => b.classList.remove('border-bit-accent', 'bg-gray-700'));
            btn.classList.add('border-bit-accent', 'bg-gray-700');
        }

        function renderProfileCountryOptions(currentCode) {
            const container = document.getElementById('profile-country-options');
            if(!container) return;
            container.innerHTML = '';
            countries.forEach(c => {
                const btn = document.createElement('button');
                const isActive = c.code === currentCode;
                btn.className = `w-8 h-8 bg-bit-dark border-2 ${isActive ? 'border-bit-accent bg-gray-700' : 'border-gray-600'} hover:border-white flex items-center justify-center text-lg transition-all`;
                btn.textContent = c.flag;
                btn.onclick = () => updateProfileCountry(c.code);
                container.appendChild(btn);
            });
        }

        function updateProfileCountry(code) {
            if(!state.user) return;
            const c = countries.find(x => x.code === code);
            document.getElementById('player-flag').textContent = c ? c.flag : '🌍';
            renderProfileCountryOptions(code);
            db.collection('users').doc(state.user.uid).set({ country: code }, { merge: true });
            playSfx('coin');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('auth-preview').src = e.target.result;
                    document.getElementById('auth-preview').classList.remove('hidden');
                    selectedAvatarBase64 = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('auth-name').value;
            const country = document.getElementById('selected-country').value;

            if(!email || !pass) return alert("MISSING DATA!");

            if(isLoginMode) {
                auth.signInWithEmailAndPassword(email, pass)
                    .then(() => { toggleAuthModal(); playSfx('win'); })
                    .catch(e => alert(e.message));
            } else {
                if(!name) return alert("NAME REQUIRED!");
                auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                    cred.user.updateProfile({ displayName: name }).then(() => {
                        db.collection('users').doc(cred.user.uid).set({
                            email: email,
                            name: name,
                            photoBase64: selectedAvatarBase64,
                            country: country,
                            xp: 0,
                            createdAt: new Date()
                        }).then(() => {
                            toggleAuthModal();
                            playSfx('win');
                            location.reload();
                        });
                    });
                }).catch(e => alert(e.message));
            }
        }

        function handleLogout() {
            // Logout Animation
            const bootScreen = document.getElementById('boot-screen');
            const bootTitle = document.getElementById('boot-title');
            const bootSub = document.getElementById('boot-sub');
            
            bootScreen.classList.remove('boot-finish');
            bootScreen.classList.add('boot-down');
            bootTitle.textContent = "SYSTEM SHUTDOWN";
            bootSub.textContent = translations[currentLang].logging_out;
            
            playSfx('hit');

            setTimeout(() => {
                auth.signOut().then(() => {
                    localStorage.removeItem('pixel_quests');
                    localStorage.removeItem('pixel_inventory');
                    localStorage.removeItem('pixel_history');
                    localStorage.removeItem('pixel_xp');
                    location.reload();
                });
            }, 1500);
        }

        function updateProfilePhoto(input) {
            if (input.files && input.files[0] && state.user) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    db.collection('users').doc(state.user.uid).set({ photoBase64: base64 }, { merge: true });
                    document.getElementById('avatar-img').src = base64;
                    document.getElementById('profile-img-lg').src = base64;
                    playSfx('coin');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- DATA SYNC ---
        function saveData() {
            localStorage.setItem('pixel_quests', JSON.stringify(state.quests));
            localStorage.setItem('pixel_inventory', JSON.stringify(state.inventory));
            localStorage.setItem('pixel_history', JSON.stringify(state.history));
            localStorage.setItem('pixel_xp', state.xp);

            if(state.user) {
                db.collection('users').doc(state.user.uid).set({
                    quests: state.quests,
                    inventory: state.inventory,
                    history: state.history,
                    xp: state.xp
                }, { merge: true });
            }
            updateXPUI();
        }

        function loadCloudData() {
            db.collection('users').doc(state.user.uid).get().then(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    if(d.quests) state.quests = d.quests;
                    if(d.inventory) state.inventory = d.inventory;
                    if(d.history) state.history = d.history;
                    if(d.xp) state.xp = d.xp;
                    if(d.xp !== undefined) state.xp = d.xp;
                    renderQuests();
                    renderInventory();
                    updateXPUI();
                    updateUIForUser(); // Refresh colors
                } else {
                    saveData(); // Sync local to cloud for new users
                }
            });
        }

        // --- ADMIN LISTENER SYSTEM ---
        function initAdminListeners(uid) {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    
                    // 1. Warning System
                    if(data.warning) {
                        document.getElementById('warning-text').textContent = data.warning;
                        document.getElementById('warning-modal').classList.remove('hidden');
                        document.getElementById('warning-modal').classList.add('flex');
                        playSfx('hit');
                    }

                    // 2. Restriction System (Mute)
                    const overlay = document.getElementById('chat-restriction-overlay');
                    const modal = document.getElementById('ban-modal');
                    
                    if(data.mutedUntil && data.mutedUntil > Date.now()) {
                        state.isMuted = true;
                        state.mutedUntil = data.mutedUntil;
                        
                        // Show Overlay
                        overlay.classList.remove('hidden');
                        overlay.classList.add('flex');
                        
                        // Start Timer
                        if(state.banInterval) clearInterval(state.banInterval);
                        updateBanTimer();
                        state.banInterval = setInterval(updateBanTimer, 1000);
                        
                        // Show Modal (if not acknowledged)
                        if(!sessionStorage.getItem('ban_acknowledged_' + data.mutedUntil)) {
                            document.getElementById('ban-reason-text').textContent = data.muteReason || "Violation of rules";
                            document.getElementById('ban-modal-timer').textContent = document.getElementById('restriction-timer').textContent;
                            modal.classList.remove('hidden');
                            modal.classList.add('flex');
                            playSfx('hit');
                        }
                    } else {
                        state.isMuted = false;
                        state.mutedUntil = null;
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                        if(state.banInterval) clearInterval(state.banInterval);
                    }
                }
            });
        }

        function updateBanTimer() {
            if(!state.mutedUntil) return;
            const diff = state.mutedUntil - Date.now();
            if(diff <= 0) return location.reload();
            const str = new Date(diff).toISOString().substr(11, 8);
            document.getElementById('restriction-timer').textContent = str;
            document.getElementById('ban-modal-timer').textContent = str;
        }

        function dismissWarning() {
            if(!state.user) return;
            // Clear warning in DB
            db.collection('users').doc(state.user.uid).update({ warning: firebase.firestore.FieldValue.delete() });
            document.getElementById('warning-modal').classList.add('hidden');
            document.getElementById('warning-modal').classList.remove('flex');
        }

        function closeBanModal() {
            document.getElementById('ban-modal').classList.add('hidden');
            document.getElementById('ban-modal').classList.remove('flex');
            if(state.mutedUntil) {
                sessionStorage.setItem('ban_acknowledged_' + state.mutedUntil, 'true');
            }
        }

        // --- QUESTS LOGIC ---
        let currentPriority = 'low';
        function setPriority(p) {
            currentPriority = p;
            document.querySelectorAll('#p-btn-low, #p-btn-medium, #p-btn-high').forEach(btn => btn.classList.remove('ring-2', 'ring-white'));
            document.getElementById(`p-btn-${p}`).classList.add('ring-2', 'ring-white');
        }
        setPriority('low');

        function addQuest() {
            const input = document.getElementById('quest-input');
            const timeInput = document.getElementById('quest-time');
            const text = input.value.trim();
            if(!text) return;

            if(state.editingQuestId) {
                state.quests = state.quests.map(q => q.id === state.editingQuestId ? {...q, text, time: timeInput.value, priority: currentPriority} : q);
                cancelEdit();
            } else {
                state.quests.unshift({
                    id: Date.now(),
                    text: text,
                    time: timeInput.value,
                    priority: currentPriority,
                    completed: false
                });
                playSfx('jump');
            }
            saveData();
            renderQuests();
            input.value = '';
            timeInput.value = '';
        }

        function renderQuests() {
            const list = document.getElementById('quest-list');
            const empty = document.getElementById('empty-state-quests');
            
            // Calculate active quests
            const active = state.quests.filter(q => !q.completed).length;
            document.getElementById('pending-count').innerHTML = `${active} <span data-i18n="active">${translations[currentLang].active}</span>`;

            list.innerHTML = '';
            if(state.quests.length === 0) {
                empty.classList.remove('hidden');
                empty.classList.add('flex');
            } else {
                empty.classList.add('hidden');
                empty.classList.remove('flex');
                
                // Sort: Not completed first, then by priority
                const sorted = [...state.quests].sort((a,b) => {
                    if(a.completed === b.completed) return 0;
                    return a.completed ? 1 : -1;
                });

                sorted.forEach(q => {
                    const style = priorityColors[q.priority || 'low'];
                    const div = document.createElement('div');
                    div.className = `bg-bit-dark border-4 ${q.completed ? 'border-gray-600 opacity-60' : 'border-black'} p-2 flex items-center gap-3 shadow-pixel group transition-all relative`;
                    
                    // Priority Marker
                    const pMarker = `<div class="absolute right-0 top-0 bottom-0 w-2 ${q.priority === 'high' ? 'bg-red-500' : q.priority === 'medium' ? 'bg-yellow-500' : 'bg-blue-500'}"></div>`;

                    div.innerHTML = `
                        ${pMarker}
                        <div onclick="toggleQuest(${q.id})" class="w-8 h-8 border-4 border-white cursor-pointer flex items-center justify-center shrink-0 ${q.completed ? 'bg-bit-success' : 'hover:bg-gray-800'}">
                            ${q.completed ? '<div class="w-3 h-3 bg-black"></div>' : ''}
                        </div>
                        <div class="flex-grow pr-3">
                            <p class="font-sans text-white text-md ${q.completed ? 'line-through text-gray-500' : ''}">${q.text}</p>
                            ${q.time ? `<span class="text-[10px] font-pixel text-bit-accent bg-black px-1">${q.time}</span>` : ''}
                        </div>
                        <div class="flex flex-col gap-1">
                            <button onclick="editQuest(${q.id})" class="text-xs text-blue-400 hover:text-white px-1"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteQuest(${q.id})" class="text-xs text-red-500 hover:text-white px-1"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        function toggleQuest(id) {
            const q = state.quests.find(x => x.id === id);
            if(q) {
                q.completed = !q.completed;
                if(q.completed) {
                    playSfx('coin');
                    addXP(20);
                    addToHistory(`COMPLETED: ${q.text}`, 'quest');
                    confetti({ particleCount: 50, spread: 60, shapes: ['square'], colors: ['#5d5ced', '#ffcd3c'] });
                } else {
                    addXP(-20);
                }
                saveData();
                renderQuests();
            }
        }

        function deleteQuest(id) {
            if(confirm("DELETE QUEST?")) {
                state.quests = state.quests.filter(q => q.id !== id);
                playSfx('hit');
                saveData();
                renderQuests();
            }
        }

        function editQuest(id) {
            const q = state.quests.find(x => x.id === id);
            if(!q) return;
            state.editingQuestId = id;
            document.getElementById('quest-input').value = q.text;
            document.getElementById('quest-time').value = q.time || '';
            setPriority(q.priority || 'low');
            document.getElementById('edit-indicator').classList.remove('hidden');
            document.getElementById('add-btn').classList.replace('bg-bit-success', 'bg-bit-accent');
        }

        function cancelEdit() {
            state.editingQuestId = null;
            document.getElementById('quest-input').value = '';
            document.getElementById('quest-time').value = '';
            document.getElementById('edit-indicator').classList.add('hidden');
            document.getElementById('add-btn').classList.replace('bg-bit-accent', 'bg-bit-success');
            setPriority('low');
        }

        // --- XP SYSTEM ---
        function addXP(amount) {
            state.xp = Math.max(0, state.xp + amount);
            updateXPUI();
        }
        function updateXPUI() {
            const level = Math.floor(state.xp / 100) + 1;
            const progress = state.xp % 100;
            
            document.getElementById('level-display').textContent = level;
            document.getElementById('xp-display').textContent = state.xp;
            document.getElementById('xp-text').textContent = `${progress}/100 XP`;
            document.getElementById('xp-bar').style.width = `${progress}%`;
            updateUIForUser(); // Update colors
        }

        // --- TIMER (BATTLE) LOGIC ---
        function switchTimerMode(mode) {
            state.timer.mode = mode;
            resetTimer(); // Reset current timer state
            
            // UI Toggle
            const btnFocus = document.getElementById('tab-focus');
            const btnStop = document.getElementById('tab-stopwatch');
            const visFocus = document.getElementById('visual-focus');
            const visStop = document.getElementById('visual-stopwatch');
            const secBtn = document.getElementById('timer-sec-btn');
            const lapsContainer = document.getElementById('laps-container');
            const presets = document.getElementById('focus-presets');
            const swReset = document.getElementById('sw-reset-corner');

            if(mode === 'focus') {
                btnFocus.classList.replace('grey', 'bg-bit-primary');
                btnStop.classList.add('grey'); btnStop.classList.remove('bg-bit-primary');
                visFocus.classList.remove('hidden'); visStop.classList.add('hidden');
                secBtn.textContent = translations[currentLang].reset;
                lapsContainer.classList.add('hidden');
                presets.classList.remove('hidden');
                state.timer.timeLeft = state.timer.initial;
                if(swReset) swReset.classList.add('hidden');
                updateTimerDisplay();
            } else {
                btnStop.classList.replace('grey', 'bg-bit-primary');
                btnFocus.classList.add('grey'); btnFocus.classList.remove('bg-bit-primary');
                visStop.classList.remove('hidden'); visFocus.classList.add('hidden');
                secBtn.textContent = "LAP"; // Keep LAP as is or translate if needed
                lapsContainer.classList.remove('hidden');
                presets.classList.add('hidden');
                document.getElementById('timer-display').textContent = "00:00";
                if(swReset) swReset.classList.remove('hidden');
            }
            playSfx('jump');
        }

        function setTimer(mins) {
            if(state.timer.mode !== 'focus') return;
            state.timer.initial = mins * 60;
            state.timer.timeLeft = state.timer.initial;
            resetTimer();
        }

        function customTimer() {
            const mins = prompt(currentLang === 'ar' ? "أدخل عدد الدقائق:" : "Enter minutes:");
            if(mins && !isNaN(mins) && mins > 0) setTimer(parseInt(mins));
        }

        function toggleTimer() {
            const btn = document.getElementById('timer-btn');
            if(state.timer.isRunning) {
                // Pause
                clearInterval(state.timer.interval);
                state.timer.isRunning = false;
                btn.textContent = "RESUME";
                btn.classList.add('yellow'); btn.classList.remove('red');
            } else {
                // Start
                state.timer.isRunning = true;
                btn.textContent = "PAUSE";
                btn.classList.remove('yellow', 'green'); btn.classList.add('red');
                playSfx('jump');

                if(state.timer.mode === 'focus') {
                    state.timer.interval = setInterval(() => {
                        if(state.timer.timeLeft > 0) {
                            state.timer.timeLeft--;
                            updateTimerDisplay();
                        } else {
                            completeFocus();
                        }
                    }, 1000);
                } else {
                    // Stopwatch
                    state.timer.swStartTime = Date.now() - state.timer.swElapsed;
                    state.timer.interval = setInterval(() => {
                        state.timer.swElapsed = Date.now() - state.timer.swStartTime;
                        updateStopwatchDisplay();
                    }, 100);
                }
            }
        }

        function completeFocus() {
            clearInterval(state.timer.interval);
            state.timer.isRunning = false;
            document.getElementById('timer-btn').textContent = "VICTORY";
            document.getElementById('timer-btn').classList.replace('red', 'green');
            playSfx('win');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            addXP(50);
            addToHistory(`FOCUS SESSION: ${state.timer.initial/60} MIN`, 'focus');
            alert("BATTLE WON! +50 XP");
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timer.timeLeft / 60).toString().padStart(2, '0');
            const s = (state.timer.timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').textContent = `${m}:${s}`;
            
            // Boss HP Bar
            const pct = (state.timer.timeLeft / state.timer.initial) * 100;
            document.getElementById('boss-hp').style.width = `${pct}%`;
        }

        function updateStopwatchDisplay() {
            const totalSec = Math.floor(state.timer.swElapsed / 1000);
            const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
            const s = (totalSec % 60).toString().padStart(2, '0');
            const ms = Math.floor((state.timer.swElapsed % 1000) / 100);
            document.getElementById('timer-display').textContent = `${m}:${s}.${ms}`;
        }

        function recordLapOrReset() {
            if(state.timer.mode === 'focus') {
                resetTimer();
            } else {
                // Record Lap
                if(!state.timer.swElapsed) return;
                const div = document.createElement('div');
                div.textContent = `LAP: ${document.getElementById('timer-display').textContent}`;
                const container = document.getElementById('laps-container');
                if(container.children[0].textContent === '-- NO LAPS --') container.innerHTML = '';
                container.prepend(div);
                playSfx('coin');
            }
        }

        function resetTimer() {
            clearInterval(state.timer.interval);
            state.timer.isRunning = false;
            
            const btn = document.getElementById('timer-btn');
            btn.textContent = translations[currentLang].start;
            btn.classList.remove('red', 'green'); btn.classList.add('yellow');

            if(state.timer.mode === 'focus') {
                state.timer.timeLeft = state.timer.initial;
                updateTimerDisplay();
                document.getElementById('boss-hp').style.width = '100%';
            } else {
                state.timer.swElapsed = 0;
                document.getElementById('timer-display').textContent = "00:00";
                document.getElementById('laps-container').innerHTML = '<div class="text-center italic">-- NO LAPS --</div>';
            }
        }

        // --- INVENTORY (NOTES) LOGIC ---
        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            const empty = document.getElementById('empty-state-notes');
            grid.innerHTML = '';

            if(state.inventory.length === 0) {
                empty.classList.remove('hidden');
                empty.classList.add('flex');
            } else {
                empty.classList.add('hidden');
                empty.classList.remove('flex');
                
                state.inventory.forEach(note => {
                    const div = document.createElement('div');
                    div.className = "bg-bit-dark border-4 border-black p-3 text-white shadow-pixel group hover:-translate-y-1 transition-transform cursor-pointer relative";
                    div.onclick = (e) => {
                        if(!e.target.closest('.delete-btn')) openNoteModal(note);
                    };
                    div.innerHTML = `
                        <p class="font-display text-lg text-bit-accent mb-1 truncate"><i class="fas fa-scroll mr-2 text-xs"></i>${note.title}</p>
                        <p class="text-xs text-gray-400 font-sans truncate">${note.body}</p>
                        <button onclick="deleteNote(${note.id})" class="delete-btn absolute top-2 left-2 text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>
                    `;
                    grid.appendChild(div);
                });
            }
        }

        function openNoteModal(note = null) {
            const modal = document.getElementById('note-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            if(note) {
                document.getElementById('note-id').value = note.id;
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-body').value = note.body;
            } else {
                document.getElementById('note-id').value = '';
                document.getElementById('note-title').value = '';
                document.getElementById('note-body').value = '';
            }
            playSfx('jump');
        }

        function closeNoteModal() {
            document.getElementById('note-modal').classList.add('hidden');
            document.getElementById('note-modal').classList.remove('flex');
        }

        function saveNote() {
            const id = document.getElementById('note-id').value;
            const title = document.getElementById('note-title').value.trim();
            const body = document.getElementById('note-body').value.trim();
            
            if(!title) return alert("ITEM NAME REQUIRED!");

            if(id) {
                state.inventory = state.inventory.map(n => n.id == id ? {...n, title, body} : n);
            } else {
                state.inventory.unshift({ id: Date.now(), title, body });
                playSfx('coin');
            }
            saveData();
            renderInventory();
            closeNoteModal();
        }

        function deleteNote(id) {
            if(confirm("DESTROY ITEM?")) {
                state.inventory = state.inventory.filter(n => n.id !== id);
                playSfx('hit');
                saveData();
                renderInventory();
            }
        }

        // --- HISTORY ---
        function addToHistory(text, type) {
            state.history.unshift({ text, type, date: new Date().toLocaleString() });
            if(state.history.length > 30) state.history.pop();
            saveData();
        }
        
        function toggleHistory() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            
            if(modal.classList.contains('hidden')) {
                list.innerHTML = '';
                if(state.history.length === 0) list.innerHTML = '<div class="text-center text-gray-500 mt-10">NO LOGS FOUND</div>';
                
                state.history.forEach(h => {
                    const div = document.createElement('div');
                    const isQuest = h.type === 'quest';
                    const borderColor = isQuest ? 'border-yellow-500' : 'border-blue-500';
                    const icon = isQuest ? '<i class="fas fa-check-circle text-yellow-500"></i>' : '<i class="fas fa-bolt text-blue-500"></i>';
                    const titleColor = isQuest ? 'text-yellow-400' : 'text-blue-400';

                    div.className = `bg-black border-l-4 ${borderColor} p-2 mb-2 font-pixel text-xs flex flex-col gap-1 shadow-sm relative overflow-hidden`;
                    div.innerHTML = `
                        <div class="absolute right-0 top-0 p-1 opacity-10 pointer-events-none"><i class="fas ${isQuest ? 'fa-scroll' : 'fa-stopwatch'} text-4xl"></i></div>
                        <div class="flex justify-between items-center z-10">
                            <div class="flex items-center gap-2 ${titleColor} font-bold uppercase tracking-wider">${icon} ${h.type || 'SYSTEM'}</div>
                            <span class="text-[8px] text-gray-500 font-sans bg-gray-900 px-1 rounded">${h.date}</span>
                        </div>
                        <div class="text-gray-300 pl-5 leading-tight z-10">${h.text}</div>
                    `;
                    list.appendChild(div);
                });
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function clearHistory() {
            state.history = [];
            saveData();
            toggleHistory(); // Refresh
        }

        // --- LEADERBOARD ---
        function openLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            const list = document.getElementById('leaderboard-list');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            playSfx('jump');

            list.innerHTML = '<div class="text-center text-gray-500 mt-10 animate-pulse">LOADING...</div>';

            // Fetch Top 30
            db.collection('users').orderBy('xp', 'desc').limit(30).get().then(snapshot => {
                list.innerHTML = '';
                if(snapshot.empty) {
                    list.innerHTML = `<div class="text-center text-gray-500 mt-10" data-i18n="no_players">${translations[currentLang].no_players}</div>`;
                    return;
                }

                let rank = 1;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const isMe = state.user && doc.id === state.user.uid;
                    const rankColor = getRankColorClass(d.xp || 0);
                    const c = countries.find(x => x.code === d.country) || { flag: '🌍' };
                    const level = Math.floor((d.xp || 0) / 100) + 1;
                    const playerName = d.name || (d.email ? d.email.split('@')[0] : 'PLAYER');
                    
                    const div = document.createElement('div');
                    div.className = `flex items-center gap-2 p-2 border-b border-gray-800 ${rank <= 3 ? 'bg-white/5' : ''}`;
                    
                    let borderClass = 'border-gray-700';
                    let textClass = 'text-gray-500';
                    let crownIcon = '';
                    
                    if(rank === 1) { 
                        borderClass = 'border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.8)]'; 
                        textClass = 'text-yellow-400'; 
                        crownIcon = '<i class="fas fa-crown text-yellow-400 text-[8px] absolute -top-2.5 left-1/2 -translate-x-1/2 drop-shadow-[0_0_5px_rgba(250,204,21,0.8)]"></i>'; 
                    }
                    else if(rank === 2) { 
                        borderClass = 'border-gray-300 shadow-[0_0_10px_rgba(209,213,219,0.8)]'; 
                        textClass = 'text-gray-300'; 
                        crownIcon = '<i class="fas fa-crown text-gray-300 text-[8px] absolute -top-3 left-1/2 -translate-x-1/2 drop-shadow-[0_0_5px_rgba(209,213,219,0.8)]"></i>'; 
                    }
                    else if(rank === 3) { 
                        borderClass = 'border-orange-400 shadow-[0_0_10px_rgba(251,146,60,0.8)]'; 
                        textClass = 'text-orange-400'; 
                        crownIcon = '<i class="fas fa-crown text-orange-400 text-[8px] absolute -top-3 left-1/2 -translate-x-1/2 drop-shadow-[0_0_5px_rgba(251,146,60,0.8)]"></i>'; 
                    }

                    div.innerHTML = `
                        <div class="relative w-8 flex justify-center shrink-0 mt-1 ${isMe ? 'scale-110' : ''}">
                            ${crownIcon}
                            <div class="w-6 h-6 border-2 ${borderClass} bg-black flex items-center justify-center font-pixel text-xs ${textClass}">${rank}</div>
                        </div>
                        <div class="text-xl">${c.flag}</div>
                        <div class="flex-grow font-sans text-sm truncate ${rankColor}">${playerName}</div>
                        <div class="text-right font-pixel text-bit-accent text-xs">
                            <div>LVL ${level}</div>
                            <div class="text-gray-500">${d.xp || 0} XP</div>
                        </div>
                    `;
                    
                    if(isMe) {
                        div.className += " bg-bit-primary/20 border-l-4 border-l-bit-primary";
                    }
                    list.appendChild(div);
                    rank++;
                });
            }).catch(error => {
                console.error("Leaderboard Error:", error);
                let msg = "ERROR";
                let subMsg = error.message;
                
                if(error.code === 'permission-denied') {
                    msg = currentLang === 'ar' ? "خطأ في الصلاحيات (Rules)" : "PERMISSION DENIED";
                    subMsg = currentLang === 'ar' ? "يجب تعديل قواعد الأمان في Firebase" : "Check Firebase Security Rules";
                } else if(error.code === 'failed-precondition') {
                    msg = currentLang === 'ar' ? "مطلوب فهرس (Index)" : "INDEX REQUIRED";
                    subMsg = currentLang === 'ar' ? "افتح الـ Console واضغط على الرابط" : "Check link in Console";
                }

                list.innerHTML = `<div class="text-center text-red-500 mt-10 text-xs font-pixel">${msg}<br><span class="text-[10px] text-gray-500">${subMsg}</span></div>`;
            });
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-modal').classList.add('hidden');
            document.getElementById('leaderboard-modal').classList.remove('flex');
        }

        // --- NAVIGATION ---
        function switchView(viewId) {
            playSfx('jump');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.nav-pixel').forEach(btn => {
                btn.classList.remove('active');
                if(btn.dataset.target === `view-${viewId}`) btn.classList.add('active');
            });

            if(viewId === 'chat') initChat();
        }

        // --- INIT ---
        updateXPUI();
        renderQuests();
        renderInventory();
        setLanguage(currentLang);

        // --- CLOCK & BOOT ---
        function updateHeaderClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const el = document.getElementById('clock-time');
            if(el) el.textContent = timeString;
        }
        setInterval(updateHeaderClock, 1000);
        updateHeaderClock();

        window.onload = () => {
            const title = document.getElementById('boot-title');
            const line = document.getElementById('boot-line');
            const sub = document.getElementById('boot-sub');
            const loader = document.getElementById('boot-loader');
            
            // Sequence
            setTimeout(() => {
                title.classList.remove('opacity-0', '-translate-y-10');
                playSfx('coin');
            }, 300);

            setTimeout(() => {
                line.classList.remove('w-0');
                line.classList.add('w-32');
            }, 1000);

            setTimeout(() => {
                sub.classList.remove('opacity-0', 'translate-y-10');
                loader.classList.remove('opacity-0');
            }, 1600);

            setTimeout(() => {
                playSfx('win');
                document.getElementById('boot-screen').classList.add('boot-finish');
            }, 3000);
        };

        // --- SOUND SETTINGS ---
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('pixel_sound', soundEnabled ? 'on' : 'off');
            updateSoundButton();
            if(soundEnabled) playSfx('coin');
        }

        function updateSoundButton() {
            const btn = document.getElementById('sound-toggle-btn');
            if(btn) {
                btn.textContent = soundEnabled ? translations[currentLang].sound_on : translations[currentLang].sound_off;
                btn.className = `pixel-btn w-full py-2 text-xs ${soundEnabled ? 'green' : 'red'}`;
            }
        }

        // --- CHAT LOGIC ---
        let chatUnsubscribe = null;
        let chatData = [];
        let chatRenderInterval = null;

        function initChat() {
            if(chatUnsubscribe) return;

            const list = document.getElementById('chat-messages');
            
            const renderChat = () => {
                const now = Date.now();
                const cutoff = now - 5 * 60 * 1000; // 5 minutes

                // Filter messages older than 5 minutes
                const visibleMsgs = chatData.filter(d => {
                    const ts = d.timestamp ? (d.timestamp.toMillis ? d.timestamp.toMillis() : Date.now()) : Date.now();
                    return ts > cutoff;
                }).sort((a, b) => {
                    const ta = a.timestamp ? (a.timestamp.toMillis ? a.timestamp.toMillis() : Date.now()) : Date.now();
                    const tb = b.timestamp ? (b.timestamp.toMillis ? b.timestamp.toMillis() : Date.now()) : Date.now();
                    return ta - tb;
                });

                list.innerHTML = '';
                if(visibleMsgs.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-500 text-xs mt-4" data-i18n="no_players">${translations[currentLang].no_players}</div>`;
                    return;
                }

                visibleMsgs.forEach(msg => {
                    const div = document.createElement('div');
                    const isMe = state.user && msg.uid === state.user.uid;
                    const c = countries.find(x => x.code === msg.country) || { flag: '🌍' };
                    const photoSrc = msg.photo || 'https://via.placeholder.com/100';
                    const nameColor = msg.xp ? getRankColorClass(msg.xp) : (isMe ? 'text-bit-success' : 'text-bit-accent');
                    const isDeleted = msg.deleted;

                    // VIP Styling
                    let vipClasses = '';
                    let vipTag = '';
                    if (msg.isVip && msg.rank <= 10) {
                        let colorClass = '';
                        let borderColor = '';

                        if (msg.rank === 1) { 
                            colorClass = 'text-yellow-400'; borderColor = 'border-yellow-400';
                            vipClasses = `${borderColor} ${colorClass} shadow-[0_0_10px_rgba(250,204,21,0.3)]`;
                        } else if (msg.rank === 2) { 
                            colorClass = 'text-gray-300'; borderColor = 'border-gray-300';
                            vipClasses = `${borderColor} ${colorClass} shadow-[0_0_10px_rgba(209,213,219,0.3)]`;
                        } else if (msg.rank === 3) { 
                            colorClass = 'text-orange-400'; borderColor = 'border-orange-400';
                            vipClasses = `${borderColor} ${colorClass} shadow-[0_0_10px_rgba(251,146,60,0.3)]`;
                        } else {
                            colorClass = 'text-indigo-400'; borderColor = 'border-indigo-400';
                            vipClasses = `${borderColor} ${colorClass} shadow-[0_0_10px_rgba(129,140,248,0.3)]`;
                        }
                        
                        const posClass = currentLang === 'ar' ? '-right-2' : '-left-2';
                        vipTag = `<div class="absolute -top-3 ${posClass} bg-black border ${borderColor} ${colorClass} text-[8px] px-1 rounded shadow-sm"><i class="fas fa-trophy"></i> #${msg.rank}</div>`;
                    }
                    
                    div.className = `flex flex-col gap-1 mb-2 ${isMe ? 'items-end' : 'items-start'}`;
                    
                    let contentHtml = isDeleted 
                        ? `<span class="text-gray-500 italic text-[10px]">${translations[currentLang].chat_deleted}</span>` 
                        : (msg.type === 'audio' ? `<audio controls playsinline src="${msg.audio}" class="h-8 w-48"></audio>` : msg.text);

                    let actionsHtml = (isMe && !isDeleted) ? `
                        <div class="absolute top-1 right-1 z-10">
                            <button onclick="toggleMessageActions(event, '${msg.id}')" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white rounded-sm hover:bg-black/30 opacity-50 group-hover:opacity-100">
                                <i class="fas fa-ellipsis-v text-xs"></i>
                            </button>
                            <div id="actions-${msg.id}" class="hidden absolute right-0 top-8 bg-black border-2 border-gray-700 rounded-md shadow-lg flex flex-col text-xs w-24">
                                ${msg.type !== 'audio' ? `<button onclick="editMessage('${msg.id}')" class="px-3 py-2 text-left text-blue-400 hover:bg-gray-800 w-full">Edit</button>` : ''}
                                <button onclick="requestDeleteMessage('${msg.id}')" class="px-3 py-2 text-left text-red-400 hover:bg-gray-800 w-full">Delete</button>
                            </div>
                        </div>
                    ` : '';

                    div.innerHTML = `
                        <div class="flex items-center gap-1 text-[10px] text-gray-500 font-pixel">
                            <img src="${photoSrc}" onclick="openPlayerProfile('${msg.uid}')" class="w-6 h-6 border-2 border-gray-600 object-cover bg-black rendering-pixelated cursor-pointer hover:border-white transition-colors">
                            <span>${c.flag}</span>
                            <span class="${isMe ? 'text-bit-success' : 'text-bit-accent'}">${msg.name}</span>
                        </div>
                        <div class="bg-bit-dark border-2 ${vipClasses || (isMe ? 'border-bit-success' : 'border-gray-600')} p-2 text-xs ${vipClasses ? '' : 'text-white'} max-w-[80%] break-words relative shadow-sm group">
                            ${contentHtml}
                            ${vipTag}
                            ${actionsHtml}
                        </div>
                    `;
                    list.appendChild(div);
                });
                list.scrollTop = list.scrollHeight;
            };

            window.toggleMessageActions = (event, id) => {
                state.selectedMessageId = id;
                document.getElementById('chat-controls').classList.add('hidden');
                document.getElementById('message-options-overlay').classList.remove('hidden');
                document.getElementById('message-options-overlay').classList.add('flex');
                playSfx('jump');
            };

            window.triggerEditMessage = () => {
                if(state.selectedMessageId) editMessage(state.selectedMessageId);
                cancelMessageOptions();
            };

            window.triggerDeleteMessage = () => {
                if(state.selectedMessageId) requestDeleteMessage(state.selectedMessageId);
                // requestDeleteMessage handles UI switching
            };

            window.cancelMessageOptions = () => {
                state.selectedMessageId = null;
                document.getElementById('message-options-overlay').classList.add('hidden');
                document.getElementById('message-options-overlay').classList.remove('flex');
                document.getElementById('chat-controls').classList.remove('hidden');
            };

            chatUnsubscribe = db.collection('global_chat')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    chatData = [];
                    snapshot.forEach(doc => chatData.push({ id: doc.id, ...doc.data() }));
                    renderChat();
                });
            
            // Re-render every 30 seconds to clean up old messages
            if(chatRenderInterval) clearInterval(chatRenderInterval);
            chatRenderInterval = setInterval(renderChat, 30000);
        }

        function sendMessage(customText = null) {
            if(!state.user) return alert(translations[currentLang].login_to_chat);
            
            // Check Mute
            if(state.isMuted) {
                playSfx('hit');
                return alert("🚫 ACCOUNT RESTRICTED: You are muted by Admin.");
            }

            const input = document.getElementById('chat-input');
            const text = customText || input.value.trim();
            if(!text) return;

            if (state.editingMessageId) {
                db.collection('global_chat').doc(state.editingMessageId).update({
                    text: text,
                    isEdited: true
                }).then(() => {
                    cancelEditMessage();
                    playSfx('coin');
                });
                return;
            }

            db.collection('users').doc(state.user.uid).get().then(doc => {
                const userData = doc.data() || {};
                const name = userData.name || state.user.displayName || 'PLAYER';
                const country = userData.country || 'global';
                const photo = userData.photoBase64 || state.user.photoURL || '';

                db.collection('global_chat').add({
                    text: text,
                    uid: state.user.uid,
                    name: name,
                    country: country,
                    photo: photo,
                    xp: state.xp,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if(!customText) input.value = '';
                playSfx('coin');
            });
        }

        function openShareMenu() {
            if(!state.user) return alert(translations[currentLang].login_to_chat);
            
            const modal = document.getElementById('share-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('share-xp-val').textContent = state.xp;
            document.getElementById('share-rank-val').textContent = state.rank || '...';

            // VIP Logic
            const vipSection = document.getElementById('vip-share-section');
            const vipOverlay = document.getElementById('vip-overlay');
            const vipInput = document.getElementById('vip-msg-input');
            const vipBtn = document.getElementById('vip-send-btn');
            
            const updateVipUI = (r) => {
                if (r && r <= 10) {
                    vipOverlay.classList.add('hidden');
                    vipOverlay.classList.remove('flex');
                    vipSection.classList.remove('opacity-50');
                    vipInput.disabled = false;
                    vipBtn.disabled = false;
                } else {
                    vipOverlay.classList.remove('hidden');
                    vipOverlay.classList.add('flex');
                    vipSection.classList.add('opacity-50');
                    vipInput.disabled = true;
                    vipBtn.disabled = true;
                }
            };

            updateVipUI(state.rank);
            playSfx('jump');

            // Refresh Rank Live (تحديث الترتيب مباشرة)
            db.collection('users').where('xp', '>', state.xp).get().then(snap => {
                const rank = snap.size + 1;
                state.rank = rank;
                document.getElementById('share-rank-val').textContent = rank;
                updateVipUI(rank);
            });
        }

        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function confirmShare(type) {
            let msg = '';
            let extraData = {};

            if (type === 'rank') {
                msg = `🏆 I am ranked #${state.rank || '?'} on the leaderboard!`;
            } else if (type === 'xp') {
                msg = `⭐ I have collected ${state.xp} XP!`;
            } else if (type === 'vip') {
                msg = document.getElementById('vip-msg-input').value.trim();
                if (!msg) return;
                extraData = { isVip: true, rank: state.rank };
            }

            sendMessage(msg, extraData);
            closeShareModal();
        }

        // --- CHAT ACTIONS (EDIT/DELETE) ---
        function requestDeleteMessage(id) {
            state.deletingMessageId = id;
            document.getElementById('chat-controls').classList.add('hidden');
            document.getElementById('recording-overlay').classList.add('hidden');
            document.getElementById('message-options-overlay').classList.add('hidden');
            document.getElementById('message-options-overlay').classList.remove('flex');
            document.getElementById('delete-confirm-overlay').classList.remove('hidden');
            document.getElementById('delete-confirm-overlay').classList.add('flex');
        }

        function cancelDeleteMessage() {
            state.deletingMessageId = null;
            document.getElementById('chat-controls').classList.remove('hidden');
            document.getElementById('delete-confirm-overlay').classList.add('hidden');
            document.getElementById('delete-confirm-overlay').classList.remove('flex');
        }

        function confirmDeleteMessage() {
            if (state.deletingMessageId) {
                db.collection('global_chat').doc(state.deletingMessageId).update({
                    deleted: true,
                    text: 'deleted',
                    audio: null,
                });
                playSfx('hit');
            }
            cancelDeleteMessage();
        }

        function editMessage(id) {
            const msg = chatData.find(m => m.id === id);
            if(!msg || msg.deleted || msg.type === 'audio') return;
            
            // Hide other overlays
            document.getElementById('chat-controls').classList.remove('hidden'); // Ensure controls are visible
            document.getElementById('recording-overlay').classList.add('hidden');
            document.getElementById('delete-confirm-overlay').classList.add('hidden');
            document.getElementById('delete-confirm-overlay').classList.remove('flex');
            document.getElementById('message-options-overlay').classList.add('hidden');
            document.getElementById('message-options-overlay').classList.remove('flex');

            state.editingMessageId = id;
            const input = document.getElementById('chat-input');
            input.value = msg.text;
            input.focus();
            
            document.getElementById('chat-mic-btn').classList.add('hidden');
            document.getElementById('chat-cancel-btn').classList.remove('hidden');
            document.getElementById('chat-send-btn').classList.replace('green', 'blue');
        }

        function cancelEditMessage() {
            state.editingMessageId = null;
            document.getElementById('chat-input').value = '';
            document.getElementById('chat-mic-btn').classList.remove('hidden');
            document.getElementById('chat-cancel-btn').classList.add('hidden');
            document.getElementById('chat-send-btn').classList.replace('blue', 'green');
        }


        // --- AUDIO RECORDING ---
        let mediaRecorder;
        let audioChunks = [];
        let recInterval;
        let recStartTime;

        function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                return alert("Audio recording not supported on this device.");
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    let mimeType = 'audio/webm';
                    if (typeof MediaRecorder.isTypeSupported === 'function') {
                        if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
                        else if (MediaRecorder.isTypeSupported('audio/ogg')) mimeType = 'audio/ogg';
                    }

                    try {
                        mediaRecorder = new MediaRecorder(stream, { mimeType });
                    } catch (e) {
                        mediaRecorder = new MediaRecorder(stream);
                    }
                    state.recordingMimeType = mediaRecorder.mimeType || mimeType;

                    audioChunks = [];
                    mediaRecorder.start();

                    // UI
                    document.getElementById('chat-controls').classList.add('hidden');
                    document.getElementById('recording-overlay').classList.remove('hidden');
                    document.getElementById('recording-overlay').classList.add('flex');
                    
                    // Timer
                    recStartTime = Date.now();
                    document.getElementById('rec-timer').textContent = "00:00";
                    recInterval = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - recStartTime) / 1000);
                        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                        const s = (elapsed % 60).toString().padStart(2, '0');
                        document.getElementById('rec-timer').textContent = `${m}:${s}`;
                        
                        // Limit to 15 seconds to avoid Firestore limits
                        if(elapsed >= 15) finishRecording();
                    }, 1000);

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });
                })
                .catch(err => {
                    console.error("Mic Error:", err);
                    alert("Microphone access denied.");
                });
        }

        function cancelRecording() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            clearInterval(recInterval);
            document.getElementById('chat-controls').classList.remove('hidden');
            document.getElementById('recording-overlay').classList.add('hidden');
            document.getElementById('recording-overlay').classList.remove('flex');
            audioChunks = [];
        }

        function finishRecording() {
            if(!mediaRecorder || mediaRecorder.state === 'inactive') return;
            mediaRecorder.stop();
            clearInterval(recInterval);
            document.getElementById('chat-controls').classList.remove('hidden');
            document.getElementById('recording-overlay').classList.add('hidden');
            document.getElementById('recording-overlay').classList.remove('flex');

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: state.recordingMimeType || 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    sendAudioMessage(reader.result);
                };
            });
        }

        function sendAudioMessage(base64) {
            if(!state.user) return alert(translations[currentLang].login_to_chat);
            
            db.collection('users').doc(state.user.uid).get().then(doc => {
                const userData = doc.data() || {};
                const name = userData.name || state.user.displayName || 'PLAYER';
                const country = userData.country || 'global';
                const photo = userData.photoBase64 || state.user.photoURL || '';

                db.collection('global_chat').add({
                    type: 'audio',
                    audio: base64,
                    uid: state.user.uid,
                    name: name,
                    country: country,
                    photo: photo,
                    xp: state.xp,
                    ...extraData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                playSfx('coin');
            });
        }

        // --- VIEW PLAYER PROFILE ---
        function openPlayerProfile(uid) {
            if(!uid) return;
            state.reportTargetUid = uid;
            const modal = document.getElementById('player-modal');
            const img = document.getElementById('view-player-img');
            const name = document.getElementById('view-player-name');
            const xp = document.getElementById('view-player-xp');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            playSfx('jump');
            
            // Reset Report Form
            document.getElementById('report-form').classList.add('hidden');
            document.getElementById('report-form').classList.remove('flex');

            // Reset / Loading
            name.textContent = "LOADING...";
            xp.textContent = "...";
            img.src = "https://via.placeholder.com/100";

            db.collection('users').doc(uid).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    name.textContent = (data.name || 'PLAYER').toUpperCase();
                    name.className = `text-2xl font-display mb-2 truncate ${getRankColorClass(data.xp || 0)}`;
                    xp.textContent = data.xp || 0;
                    if(data.photoBase64) img.src = data.photoBase64;
                } else {
                    name.textContent = "UNKNOWN PLAYER";
                }
            });
        }

        function closePlayerProfile() {
            const modal = document.getElementById('player-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            state.reportTargetUid = null;
        }

        function toggleReportForm() {
            const form = document.getElementById('report-form');
            if(form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                form.classList.add('flex');
            } else {
                form.classList.add('hidden');
                form.classList.remove('flex');
            }
        }

        function submitReport(reasonType) {
            if(!state.user) return alert(translations[currentLang].login_to_chat);
            if(!state.reportTargetUid) return;

            let reason = reasonType;
            if(reasonType === 'custom') {
                reason = document.getElementById('report-custom-input').value.trim();
            }
            
            if(!reason) return;

            db.collection('reports').add({
                reporterUid: state.user.uid,
                reporterName: state.user.displayName || 'Anonymous',
                reportedUid: state.reportTargetUid,
                reason: reason,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            }).then(() => {
                alert(translations[currentLang].report_sent);
                toggleReportForm();
                document.getElementById('report-custom-input').value = '';
            }).catch(e => alert(e.message));
        }

        // --- PROFILE ACTIONS ---
        function editProfileName() {
            if(state.xp < 300) return alert(translations[currentLang].no_xp);
            if(!confirm(translations[currentLang].edit_name_cost)) return;
            
            const newName = prompt(translations[currentLang].name_ph);
            if(newName && newName.trim()) {
                addXP(-300);
                state.user.updateProfile({ displayName: newName.trim() }).then(() => {
                    db.collection('users').doc(state.user.uid).set({ name: newName.trim() }, { merge: true });
                    updateUIForUser();
                    playSfx('coin');
                });
            }
        }

        function showChangePassword() {
            hideActionForms();
            document.getElementById('action-form-pass').classList.remove('hidden');
            document.getElementById('action-form-pass').classList.add('flex');
        }

        function showDeleteAccount() {
            hideActionForms();
            document.getElementById('action-form-del').classList.remove('hidden');
            document.getElementById('action-form-del').classList.add('flex');
        }

        function hideActionForms() {
            document.getElementById('action-form-pass').classList.add('hidden');
            document.getElementById('action-form-pass').classList.remove('flex');
            document.getElementById('action-form-del').classList.add('hidden');
            document.getElementById('action-form-del').classList.remove('flex');
            document.getElementById('cp-current').value = '';
            document.getElementById('cp-new').value = '';
            document.getElementById('cp-confirm').value = '';
            document.getElementById('del-pass').value = '';
        }

        function confirmChangePassword() {
            const curr = document.getElementById('cp-current').value;
            const newP = document.getElementById('cp-new').value;
            const confP = document.getElementById('cp-confirm').value;

            if(!curr || !newP) return alert("FILL ALL FIELDS");
            if(newP !== confP) return alert("PASSWORDS DO NOT MATCH");

            const cred = firebase.auth.EmailAuthProvider.credential(state.user.email, curr);
            state.user.reauthenticateWithCredential(cred).then(() => {
                state.user.updatePassword(newP).then(() => {
                    alert("PASSWORD UPDATED");
                    hideActionForms();
                    playSfx('win');
                }).catch(e => alert(e.message));
            }).catch(e => alert("WRONG CURRENT PASSWORD"));
        }

        function confirmDeleteAccount() {
            const pass = document.getElementById('del-pass').value;
            if(!pass) return alert("PASSWORD REQUIRED");

            const cred = firebase.auth.EmailAuthProvider.credential(state.user.email, pass);
            state.user.reauthenticateWithCredential(cred).then(() => {
                if(confirm("FINAL WARNING: DELETE ACCOUNT?")) {
                    db.collection('users').doc(state.user.uid).delete();
                    state.user.delete().then(() => {
                        alert("ACCOUNT DELETED");
                        location.reload();
                    });
                }
            }).catch(e => alert("WRONG PASSWORD"));
        }

        function updatePlayerRank() {
            if(!state.user) return;
            
            // Update Status Text
            document.getElementById('rank-status-text').textContent = getRankTitle(state.xp);
            document.getElementById('rank-status-text').className = `font-bold ${getRankColorClass(state.xp)}`;

            // Fetch Rank Number
            db.collection('users').where('xp', '>', state.xp).get().then(snap => {
                const rank = snap.size + 1;
                document.getElementById('rank-num').textContent = rank;
                state.rank = rank;
            });
        }

    </script>
</body>
</html>
